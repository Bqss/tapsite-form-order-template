<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>tapsite.ai • Single Product + Addons • Form 2</title>
  <script src="https://cdn.tailwindcss.com/3.4.16"></script>
</head>

<body
  data-products='[{"id":"BASE-001","name":"Cupcake Base","price":6000,"description":"Produk utama.","image_url":"https://imageio.forbes.com/specials-images/imageserve/65df2e0562b5d061b718a4af/0x0.jpg?format=jpg&height=900&width=1600&fit=bounds","is_addon":false,"quantity":1,"weight":200},{"id":"ADD-CHIP","name":"Chocolate Chips","price":1500,"description":"Tambahan choco chips","image_url":"https://imageio.forbes.com/specials-images/imageserve/65df2e0562b5d061b718a4af/0x0.jpg?format=jpg&height=900&width=1600&fit=bounds","is_addon":true,"quantity":1},{"id":"ADD-NUT","name":"Peanut","price":2000,"description":"Tambahan kacang","image_url":"https://imageio.forbes.com/specials-images/imageserve/65df2e0562b5d061b718a4af/0x0.jpg?format=jpg&height=900&width=1600&fit=bounds","is_addon":true,"quantity":1}]'
  data-fields='{"fields":[{"id":"name","label":"Nama","type":"text","required":true},{"id":"email","label":"Email","type":"email","required":false},{"id":"phone","label":"Nomor Telepon","type":"tel","required":true}]}'
  data-domain="http://localhost:5556"
  data-origin-id="spa-form2"
  data-form-id="019a5bcf-ec8a-7-a2cc-c58ec5e57de56595"
>
  <section class="min-h-screen bg-gradient-to-br from-teal-50 via-emerald-50 to-cyan-50 py-6 lg:py-10">
    <div class="max-w-6xl mx-auto px-4">
      <header class="mb-6 lg:mb-8">
        <div class="rounded-3xl bg-gradient-to-b from-teal-700 to-emerald-600 text-white p-6 sm:p-8 shadow-xl">
          <h1 class="text-3xl font-extrabold tracking-tight">Order Form • Single Product + Addons</h1>
          <p class="mt-2 opacity-90">Pilih addons opsional untuk menambah nilai pesanan.</p>
        </div>
      </header>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Left: Base Product + Addons -->
        <div class="space-y-4">
          <div class="bg-white rounded-3xl shadow-xl ring-1 ring-teal-100 p-4 sm:p-5">
            <div class="p-4">
              <h2 class="text-xl font-semibold text-gray-900 mb-4">Produk</h2>
              <div id="products" class="space-y-3">
                <div data-role="product" data-template="product" class="group bg-white/80 backdrop-blur-sm border border-teal-100 rounded-2xl p-3 shadow-sm hover:shadow-md hover:-translate-y-0.5 hover:ring-1 hover:ring-teal-300 transition-all duration-300">
                  <div class="flex items-center gap-3">
                    <img data-value="image_url" src="https://imageio.forbes.com/specials-images/imageserve/65df2e0562b5d061b718a4af/0x0.jpg?format=jpg&height=900&width=1600&fit=bounds" alt="Produk" class="w-20 h-20 rounded-xl object-cover border border-gray-200" />
                    <div class="flex-1 min-w-0">
                      <div class="flex items-start justify-between gap-2">
                        <h3 class="text-lg font-bold text-gray-900" data-value="name">Nama Produk</h3>
                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-teal-50 text-teal-700 border border-teal-100">Produk utama</span>
                      </div>
                      <p class="text-base text-gray-600" data-value="description">Deskripsi singkat produk.</p>
                      <div class="mt-2 flex items-center gap-3">
                        <p class="text-lg text-teal-600 font-semibold" data-value="price">Rp 0</p>
                        <span class="text-sm text-gray-500">Berat: 200g</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-3xl shadow-xl ring-1 ring-teal-100 p-4 sm:p-5">
            <div class="p-4">
              <h3 class="text-lg font-semibold text-gray-900 mb-3">Addon (Opsional)</h3>
              <div id="addonsList" class="flex flex-col gap-3">
                <div id="addonItemTemplate" data-template="addon-item" class="hidden">
                  <label class="group flex items-start gap-3 p-4 bg-white/80 backdrop-blur-sm border border-teal-100 rounded-2xl hover:shadow-md hover:-translate-y-0.5 hover:ring-1 hover:ring-teal-300 transition-all duration-300 cursor-pointer">
                    <input type="checkbox" class="mt-1.5 w-4 h-4 text-teal-600 focus:ring-teal-500" />
                    <div class="flex-1">
                      <div class="flex justify-between items-start gap-2">
                        <span class="text-base font-medium text-gray-900" data-field="name">Addon</span>
                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-sm font-semibold bg-teal-50 text-teal-700 border border-teal-100" data-field="price">Rp 0</span>
                      </div>
                      <p class="text-sm text-gray-600 mt-1" data-field="description"></p>
                    </div>
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Right: Summary + Identity form dalam satu kartu (konsisten dengan quantity_based) -->
        <div>
          <form id="orderForm" class="bg-white rounded-3xl shadow-xl ring-1 ring-teal-100 p-6 sm:p-8">
            <h2 class="text-2xl font-bold text-gray-900">Order Summary</h2>
            <p class="text-sm text-gray-600 mt-1">Pilihanmu:</p>

            <!-- Ringkasan Pesanan -->
            <div data-role="parent" class="mt-4">
              <div class="bg-gradient-to-br from-white to-cyan-50 rounded-2xl p-4 border border-teal-100">
                <div id="summaryItems" class="space-y-3"></div>

                <!-- Template summary item -->
                <div id="summaryItemTemplate" data-template="summary-item" data-role="summary-item" data-placeholder="true" class="hidden">
                  <div class="flex items-center justify-between pb-3 border-b border-teal-100">
                    <div>
                      <h3 class="font-semibold text-gray-900" data-summary="name">Nama Produk</h3>
                      <p class="text-xs text-gray-500">Berat: <span data-summary="weight">200</span>g</p>
                    </div>
                    <div class="text-right">
                      <p class="font-semibold text-gray-900">Rp <span data-summary="line_total">0</span></p>
                    </div>
                  </div>
                </div>

                <div class="flex items-center justify-between pt-2">
                  <h3 class="text-lg font-bold text-gray-900">Total</h3>
                  <p class="text-xl font-extrabold text-teal-700">Rp <span id="totalPrice">0</span></p>
                </div>
              </div>
            </div>

            <!-- Informasi Identitas -->
            <div data-role="parent" class="mt-6">
              <h3 class="text-lg font-bold text-gray-900 mb-3">Detail Pemesan</h3>
              <div id="forms" class="grid grid-cols-1 gap-4">
                <!-- Template Field -->
                <div data-role="field" data-template="field" class="space-y-2">
                  <label for="name" class="block text-sm font-medium text-gray-700" data-value="label">Nama <span class="text-red-500">*</span></label>
                  <input type="text" id="name" name="name" required data-value-id data-value-type data-value-required class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all" placeholder="Masukkan nama lengkap" />
                </div>
              </div>
            </div>

            <!-- Trust & Submit -->
            <div class="mt-6">
              <div class="flex flex-wrap items-center justify-center gap-4 text-sm text-gray-500">
                <div class="flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-emerald-500 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>Pembayaran Aman</div>
                <div class="flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-emerald-500 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/></svg>Data Terenkripsi</div>
              </div>
            </div>

            <div class="mt-6 flex justify-center">
              <button type="submit" id="submitBtn" class="w-full sm:w-auto px-8 py-4 bg-gradient-to-r from-teal-600 to-cyan-600 text-white font-bold rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2">
                Selesaikan Pesanan
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Success Modal (match quantity_based style) -->
      <div id="successMessage" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
        <div id="successContent" class="bg-white rounded-2xl p-8 max-w-md mx-4 transform transition-all duration-300 scale-95 opacity-0">
          <div class="text-center">
            <div class="w-16 h-16 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-emerald-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-2">Pesanan Berhasil!</h3>
            <p class="text-gray-600 mb-6">Terima kasih. Kamu akan diarahkan ke halaman pembayaran.</p>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div class="bg-teal-600 h-2 rounded-full" id="progressBar" style="width:0%"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <script>
    // Konstanta domain & konfigurasi (selaras dengan quantity_based)
    const domain = document.body.dataset.domain || '';
    const originId = document.body.dataset.originId || '';
    const productWeight = 200;
    const fmt = (n)=>Number(n||0).toLocaleString('id-ID');
    const state = { base:null, addons:[], fields:[] };
    const orderForm = document.getElementById('orderForm');
    const successMessage = document.getElementById('successMessage');
    const successContent = document.getElementById('successContent');
    const progressBar = document.getElementById('progressBar');

    (function init(){
      const raw = document.body.dataset.products || '[]';
      const products = JSON.parse(raw.replace(/'/g,'"'));
      state.base = products.find(p=>!p.is_addon);
      state.addons = products.filter(p=>p.is_addon).map(a=>({ ...a, selected:false }));
      renderBase();
      renderAddons();
      renderForms();
      updateSummary();
    })();

    function renderBase(){
      const el = document.querySelector('[data-role="product"]'); const p = state.base; if(!el||!p) return;
      const img = el.querySelector('[data-value="image_url"]'); if(img && p.image_url) img.src = p.image_url;
      el.querySelector('[data-value="name"]').textContent = p.name || '';
      el.querySelector('[data-value="description"]').textContent = p.description || '';
      el.querySelector('[data-value="price"]').textContent = 'Rp ' + fmt(p.price);
    }

    function renderAddons(){
      const list = document.getElementById('addonsList'); const tpl = document.getElementById('addonItemTemplate');
      list.innerHTML = '';
      state.addons.forEach((a, idx)=>{
        const el = tpl.cloneNode(true); el.classList.remove('hidden'); el.removeAttribute('id');
        el.querySelector('[data-field="name"]').textContent = a.name;
        el.querySelector('[data-field="price"]').textContent = 'Rp ' + fmt(a.price);
        el.querySelector('[data-field="description"]').textContent = a.description || '';
        const cb = el.querySelector('input[type="checkbox"]');
        cb.checked = !!a.selected; cb.addEventListener('change',()=>{ a.selected = cb.checked; updateSummary(); });
        list.appendChild(el);
      });
    }

    function renderForms(){
      const raw = document.body.dataset.fields || '{}'; const parsed = JSON.parse(raw.replace(/'/g,'"'));
      const fields = Array.isArray(parsed.fields)?parsed.fields:[]; state.fields = fields;
      const container = document.getElementById('forms'); const tpl = container.querySelector('[data-template="field"]');
      container.innerHTML = '';
      fields.forEach(f=>{ const el = tpl.cloneNode(true); const label = el.querySelector('[data-value="label"]'); const input = el.querySelector('input');
        if(label){ label.textContent = f.label + (f.required?' *':''); }
        if(input){ input.id=f.id; input.name=f.id; input.type=f.type||'text'; input.required=!!f.required; input.placeholder=`Masukkan ${f.label}`; }
        container.appendChild(el); });
    }

    function updateSummary(){
      const summary = document.getElementById('summaryItems'); const tpl = document.getElementById('summaryItemTemplate');
      summary.innerHTML = '';
      if(state.base){ const el = tpl.cloneNode(true); el.classList.remove('hidden');
        el.querySelector('[data-summary="name"]').textContent = state.base.name;
        el.querySelector('[data-summary="weight"]').textContent = productWeight;
        el.querySelector('[data-summary="line_total"]').textContent = fmt(state.base.price);
        summary.appendChild(el); }
      state.addons.filter(a=>a.selected).forEach(a=>{ const el = tpl.cloneNode(true); el.classList.remove('hidden');
        el.querySelector('[data-summary="name"]').textContent = `${a.name} (addon)`;
        el.querySelector('[data-summary="weight"]').textContent = 0;
        el.querySelector('[data-summary="line_total"]').textContent = fmt(a.price);
        summary.appendChild(el); });
      const total = Number(state.base?.price||0) + state.addons.filter(a=>a.selected).reduce((s,a)=>s+Number(a.price||0),0);
      document.getElementById('totalPrice').textContent = fmt(total);
    }

    // Submit Handling mengikuti pola template-1
    orderForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Memproses...';

      const base = state.base; 
      if(!base){ 
        alert('Produk belum tersedia.'); 
        submitBtn.disabled = false;
        submitBtn.textContent = 'Selesaikan Pesanan';
        return; 
      }

      // Ambil data form
      const formData = new FormData(orderForm);
      const data = Object.fromEntries(formData.entries());
      
      // Get UTM parameters
      const urlParams = new URLSearchParams(window.location.search);
      const utmSource = urlParams.get('utm_source') || '';
      const utmMedium = urlParams.get('utm_medium') || '';
      const utmCampaign = urlParams.get('utm_campaign') || '';
      const utmContent = urlParams.get('utm_content') || '';
      
      // Prepare customer data
      const customerData = {
        ...data,
        address: data.address || '',
        full_address: data.address || '',
        utm_meta: {
          utm_source: utmSource,
          utm_medium: utmMedium,
          utm_campaign: utmCampaign,
          utm_content: utmContent
        }
      };
      
      // Prepare product data - base product + selected addons
      const selectedAddons = state.addons.filter(a => a.selected);
      const productData = [
        {
          id: base.id,
          code: base.id,
          name: base.name,
          price: base.price,
          quantity: 1,
          is_addon: false
        },
        ...selectedAddons.map(a => ({
          id: a.id,
          code: a.id,
          name: a.name,
          price: a.price,
          quantity: 1,
          is_addon: true
        }))
      ];
      
      // Calculate subtotal and total
      const subtotal = Number(base.price||0) + selectedAddons.reduce((s,a)=> s + Number(a.price||0), 0);
      const total = subtotal;
      
      const payload = {
        customer_data: customerData,
        subtotal: subtotal,
        total: total,
        product: productData
      };

      try {
        const response = await fetch(`${domain}/form/${document.body.dataset.formId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        const result = await response.json();
        
        // Track pixel events
        const submitEvent = document.body.dataset.submitEvent || 'Lead';
        if (typeof fbq !== 'undefined') {
          fbq('track', submitEvent, {
            value: total,
            currency: 'IDR'
          });
        }
        
        if (typeof ttq !== 'undefined') {
          ttq.track(submitEvent, {
            value: total,
            currency: 'IDR'
          });
        }
        
        if (typeof twq !== 'undefined') {
          twq('event', submitEvent, {
            value: total,
            currency: 'IDR'
          });
        }
        
        if(response.ok && result.id) {
          // Show success message
          successMessage.classList.remove('hidden');
          setTimeout(() => {
            successContent.classList.remove('scale-95', 'opacity-0');
            successContent.classList.add('scale-100', 'opacity-100');
            
            // Animate progress bar
            let width = 0;
            const interval = setInterval(() => {
              width += 10;
              progressBar.style.width = width + '%';
              
              if (width >= 100) {
                clearInterval(interval);
                // Redirect to invoice page
                window.location.href = `${domain}/invoice/${result.id}`;
              }
            }, 100);
          }, 100);
        } else {
          alert('Gagal membuat pesanan. Silakan coba lagi.');
        }
      } catch (error) {
        console.error('Error submitting order:', error);
        alert('Terjadi kesalahan. Silakan coba lagi.');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Selesaikan Pesanan';
      }
    });
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>tapsite.ai • Single Product • Form 2 (PF)</title>
  <script src="https://cdn.tailwindcss.com/3.4.16"></script>
</head>

<body
  data-products='[{"id":"SP-01","name":"Cupcake Premium","price":20000,"description":"Cupcake premium dengan tekstur lembut.","image_url":"https://imageio.forbes.com/specials-images/imageserve/65df2e0562b5d061b718a4af/0x0.jpg?format=jpg&height=900&width=1600&fit=bounds","is_addon":false,"quantity":1}]'
  data-fields='{"fields":[{"id":"name","label":"Nama","type":"text","required":true},{"id":"email","label":"Email","type":"email","required":false},{"id":"phone","label":"Nomor Telepon","type":"tel","required":true}]}'
  data-domain="http://localhost:5556"
  data-origin-id="5fc63944f8f44b34aa4c819e"
>
  <section class="min-h-screen bg-gradient-to-br from-teal-50 via-emerald-50 to-cyan-50 py-6 lg:py-10">
    <div class="max-w-6xl mx-auto px-4">
      <header class="mb-6 lg:mb-8">
        <div class="rounded-3xl bg-gradient-to-b from-teal-700 to-emerald-600 text-white p-6 sm:p-8 shadow-xl">
          <h1 class="text-3xl font-extrabold tracking-tight">Order Form • Produk Fisik (Single)</h1>
          <p class="mt-2 opacity-90">Versi produk fisik dengan informasi pengiriman.</p>
        </div>
      </header>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Left: Product -->
        <div class="space-y-4">
          <div class="bg-white rounded-3xl shadow-xl ring-1 ring-teal-100 p-4 sm:p-5">
            <div class="p-4">
              <h2 class="text-xl font-semibold text-gray-900 mb-4">Produk</h2>
              <div id="products" class="space-y-3">
                <div data-role="product" data-template="product" class="group bg-white/80 backdrop-blur-sm border border-teal-100 rounded-2xl p-3 shadow-sm hover:shadow-md hover:-translate-y-0.5 hover:ring-1 hover:ring-teal-300 transition-all duration-300">
                  <div class="flex items-center gap-3">
                    <img data-value="image_url" src="https://imageio.forbes.com/specials-images/imageserve/65df2e0562b5d061b718a4af/0x0.jpg?format=jpg&height=900&width=1600&fit=bounds" alt="Produk" class="w-20 h-20 rounded-xl object-cover border border-gray-200" />
                    <div class="flex-1 min-w-0">
                      <div class="flex items-start justify-between gap-2">
                        <h3 class="text-lg font-bold text-gray-900" data-value="name">Nama Produk</h3>
                        <span class="text-sm text-gray-500">200g</span>
                      </div>
                      <p class="text-sm text-gray-600" data-value="description">Deskripsi singkat produk.</p>
                      <div class="mt-2 flex items-center gap-3">
                        <p class="text-lg text-teal-600 font-semibold" data-value="price">Rp 0</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Right: Summary + Identity + Shipping -->
        <div>
          <form id="orderForm" class="bg-white rounded-3xl shadow-xl ring-1 ring-teal-100 p-6 sm:p-8">
            <h2 class="text-2xl font-bold text-gray-900">Order Summary</h2>
            <p class="text-sm text-gray-600 mt-1">Detail pesananmu:</p>

            <!-- Ringkasan Pesanan -->
            <div data-role="parent" class="mt-4">
              <div class="bg-gradient-to-br from-white to-cyan-50 rounded-2xl p-4 border border-teal-100">
                <div id="summaryItems" class="space-y-3"></div>

                <!-- Template summary item -->
                <div id="summaryItemTemplate" data-template="summary-item" data-role="summary-item" data-placeholder="true" class="hidden">
                  <div class="flex items-center justify-between pb-3 border-b border-teal-100">
                    <div>
                      <h3 class="font-semibold text-gray-900" data-summary="name">Nama Produk</h3>
                      <p class="text-xs text-gray-500">Berat: <span data-summary="weight">200</span>g</p>
                    </div>
                    <div class="text-right">
                      <p class="text-sm text-gray-600">Rp <span data-summary="unit_price">0</span> × <span data-summary="qty">1</span></p>
                      <p class="font-semibold text-gray-900">Rp <span data-summary="line_total">0</span></p>
                    </div>
                  </div>
                </div>

                <!-- Shipping Info (hidden until courier selected) -->
                <div id="shippingInfo" class="hidden">
                  <div class="pb-3 border-b border-teal-100">
                    <h4 class="font-medium text-gray-900 mb-2">Informasi Pengiriman</h4>
                    <p class="text-sm text-gray-600" id="shippingAddress"></p>
                    <p class="text-sm text-gray-600 mt-1">Kurir: <span id="selectedCourier">-</span></p>
                    <p class="text-sm text-gray-600">Ongkos Kirim: Rp <span id="shippingCost">0</span></p>
                  </div>
                </div>

                <div class="flex items-center justify-between pt-2">
                  <h3 class="text-lg font-bold text-gray-900">Total</h3>
                  <p class="text-xl font-extrabold text-teal-700">Rp <span id="totalPrice">0</span></p>
                </div>
              </div>
            </div>

            <!-- Informasi Identitas -->
            <div data-role="parent" class="mt-6">
              <h3 class="text-lg font-bold text-gray-900 mb-3">Detail Pemesan</h3>
              <div id="forms" class="grid grid-cols-1 gap-4">
                <!-- Template Field -->
                <div data-role="field" data-template="field" class="space-y-2">
                  <label for="name" class="block text-sm font-medium text-gray-700" data-value="label">Nama <span class="text-red-500">*</span></label>
                  <input type="text" id="name" name="name" required data-value-id data-value-type data-value-required class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all" placeholder="Masukkan nama lengkap" />
                </div>
              </div>
            </div>

            <!-- Informasi Pengiriman -->
            <div data-role="parent" class="mt-6">
              <h3 class="text-lg font-bold text-gray-900 mb-3">Informasi Pengiriman</h3>
              <div class="space-y-6">
                <div class="relative">
                  <label for="subdistrict" class="block text-sm font-medium text-gray-700 mb-2">Desa/Kelurahan <span class="text-red-500">*</span></label>
                  <input type="text" id="subdistrict" name="subdistrict" required class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all" placeholder="Ketik nama desa/kelurahan...">
                  <div id="dropdown" class="absolute bottom-full left-0 right-0 bg-white border-2 border-gray-200 rounded-lg shadow-lg z-50 max-h-60 overflow-y-auto hidden w-full mb-2">
                    <div id="loading" class="p-3 text-center hidden">Mencari...</div>
                    <div id="results"></div>
                  </div>
                </div>
                <div>
                  <label for="address" class="block text-sm font-medium text-gray-700 mb-2">Alamat Lengkap <span class="text-red-500">*</span></label>
                  <textarea id="address" name="address" rows="3" required class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all" placeholder="Nama jalan, nomor rumah, RT/RW, patokan"></textarea>
                </div>

                <div id="courierOptions">
                  <label class="block text-sm font-medium text-gray-700 mb-2">Pilih Kurir <span class="text-red-500">*</span></label>
                  <div id="courierGuard" class="mb-3 p-3 border-2 border-dashed border-gray-300 rounded-lg text-center text-sm text-gray-600">Pilih alamat terlebih dahulu untuk melihat pilihan kurir dan menghitung ongkir.</div>
                  <div id="courierList" class="space-y-3 grid grid-cols-2 gap-2">
                    <div id="courierLoading" class="col-span-2 p-3 border-2 border-gray-200 rounded-lg text-gray-600 text-sm flex items-center gap-2 hidden">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 animate-spin text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a7 7 0 100 14v-2a5 5 0 110-10V3z" clip-rule="evenodd"></path></svg>
                      <span>Sedang menghitung ongkir dan mengambil daftar kurir...</span>
                    </div>
                    <div id="courierItemTemplate" data-role="courier-item" data-template="courier-item" data-placeholder="true" class="flex items-center p-3 border-2 border-gray-200 rounded-lg hover:border-teal-300 transition-colors cursor-pointer hidden">
                      <input type="radio" name="courier" class="mr-3 w-4 h-4 text-teal-600 focus:ring-teal-500" />
                      <label class="flex-1 cursor-pointer">
                        <div class="flex justify-between items-center">
                          <span class="font-medium" data-field="name">Nama Kurir</span>
                          <span class="text-teal-600 font-semibold" data-field="price">Rp 0</span>
                        </div>
                        <div class="text-sm text-gray-500">Estimasi: <span data-field="eta">2-3 Hari</span></div>
                      </label>
                    </div>
                  </div>
                  <div id="courierError" class="mt-2 text-red-500 text-sm hidden">Silakan pilih kurir pengiriman</div>
                </div>
              </div>
            </div>

            <!-- Trust & Submit -->
            <div class="mt-6">
              <div class="flex flex-wrap items-center justify-center gap-4 text-sm text-gray-500">
                <div class="flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-emerald-500 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>Pembayaran Aman</div>
                <div class="flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-emerald-500 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/></svg>Data Terenkripsi</div>
              </div>
            </div>

            <div class="mt-6 flex justify-center">
              <button type="submit" id="submitBtn" class="w-full sm:w-auto px-8 py-4 bg-gradient-to-r from-teal-600 to-cyan-600 text-white font-bold rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2">
                Selesaikan Pesanan
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Success Modal -->
      <div id="successMessage" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
        <div id="successContent" class="bg-white rounded-2xl p-8 max-w-md mx-4 transform transition-all duration-300 scale-95 opacity-0">
          <div class="text-center">
            <div class="w-16 h-16 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-emerald-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-2">Pesanan Berhasil!</h3>
            <p class="text-gray-600 mb-6">Terima kasih. Kamu akan diarahkan ke halaman pembayaran.</p>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div class="bg-teal-600 h-2 rounded-full" id="progressBar" style="width:0%"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <script>
    // Konstanta & elemen
    const domain = document.body.dataset.domain || '';
    const originId = document.body.dataset.originId || '';
    const productWeight = 200; // gram per item
    const fmt = (n)=>Number(n||0).toLocaleString('id-ID');
    const orderForm = document.getElementById('orderForm');
    const successMessage = document.getElementById('successMessage');
    const successContent = document.getElementById('successContent');
    const progressBar = document.getElementById('progressBar');
    const totalPriceElement = document.getElementById('totalPrice');

    // Shipping refs
    const subdistrictInput = document.getElementById('subdistrict');
    const dropdown = document.getElementById('dropdown');
    const loadingElement = document.getElementById('loading');
    const resultsElement = document.getElementById('results');
    const courierOptions = document.getElementById('courierOptions');
    const courierList = document.getElementById('courierList');
    const courierGuard = document.getElementById('courierGuard');
    const courierLoadingEl = document.getElementById('courierLoading');
    const addressInput = document.getElementById('address');
    let debounceTimer; let selectedAddress = null;

    // State produk & fields
    const state = { product:null, fields:[] };

    (function init(){
      // Render produk dari data-products
      try {
        const raw = document.body.dataset.products || '[]';
        const products = JSON.parse(raw.replace(/'/g,'"'));
        const p = products[0];
        state.product = p || null;
        const container = document.getElementById('products');
        const tpl = container.querySelector('[data-template="product"]');
        if(p && tpl){
          const el = tpl.cloneNode(true); el.removeAttribute('data-template');
          const img = el.querySelector('[data-value="image_url"]'); if(img && p.image_url) { img.src = p.image_url; img.alt = p.name || 'Produk'; }
          el.querySelector('[data-value="name"]').textContent = p.name || '';
          el.querySelector('[data-value="description"]').textContent = p.description || '';
          el.querySelector('[data-value="price"]').textContent = 'Rp ' + fmt(p.price);
          container.innerHTML = ''; container.appendChild(el);
        }
      } catch(e) { console.warn('Gagal render produk:', e); }

      // Render fields
      try {
        const raw = document.body.dataset.fields || '{}';
        const parsed = JSON.parse(raw.replace(/'/g,'"'));
        const fields = Array.isArray(parsed.fields)?parsed.fields:[]; state.fields = fields;
        const container = document.getElementById('forms');
        const tpl = container.querySelector('[data-template="field"]');
        container.innerHTML = '';
        fields.forEach(f=>{ const el = tpl.cloneNode(true); const label = el.querySelector('[data-value="label"]'); const input = el.querySelector('input');
          if(label){ label.innerHTML = `${f.label}${f.required? ' <span class=\"text-red-500\">*</span>':''}`; label.setAttribute('for', f.id); }
          if(input){ input.id=f.id; input.name=f.id; input.type=f.type||'text'; input.required=!!f.required; input.placeholder = `Masukkan ${f.label}`; }
          container.appendChild(el); });
      } catch(e){ console.warn('Gagal render fields:', e); }

      // Init customerData
      const priceNum = Number(state.product?.price||0);
      window.customerData = { quantity:1, subtotal: priceNum, weight: productWeight };

      updateSummary();

      // Pindahkan Ringkasan Pesanan ke bawah kurir dan tambahkan heading
      try {
        const summaryParent = document.getElementById('summaryItems')?.closest('[data-role="parent"]');
        if(summaryParent && courierOptions){
          // Hapus heading lama Order Summary dan deskripsinya jika ada
          const headingEl = orderForm.querySelector('h2');
          const descEl = headingEl?.nextElementSibling;
          if(headingEl) headingEl.remove();
          if(descEl && descEl.tagName === 'P') descEl.remove();

          // Sisipkan setelah opsi kurir
          courierOptions.insertAdjacentElement('afterend', summaryParent);
          // Tambahkan heading kecil
          const h3 = document.createElement('h3');
          h3.className = 'text-lg font-bold text-gray-900 mb-3';
          h3.textContent = 'Ringkasan Pesanan';
          summaryParent.insertAdjacentElement('beforebegin', h3);
        }
      } catch(err){ console.warn('Gagal memindahkan ringkasan pesanan:', err); }

      // Sinkronisasi alamat textarea ke shipping summary
      if(addressInput){
        addressInput.addEventListener('input', function(){
          const val = (this.value||'').trim();
          window.customerData.address = val;
          if(selectedAddress){
            window.customerData.full_address = `${val}, ${selectedAddress.subdistrict}, ${selectedAddress.district}, ${selectedAddress.city}, ${selectedAddress.province}`;
          } else {
            window.customerData.full_address = val;
          }
          const shippingAddressEl = document.getElementById('shippingAddress');
          if(shippingAddressEl){ shippingAddressEl.textContent = window.customerData.full_address || val; }
        });
      }
    })();

    function updateSummary(){
      const summary = document.getElementById('summaryItems');
      const tpl = document.getElementById('summaryItemTemplate');
      summary.innerHTML = '';
      const p = state.product; if(!p) return;
      const el = tpl.cloneNode(true); el.classList.remove('hidden');
      el.querySelector('[data-summary="name"]').textContent = p.name || '';
      el.querySelector('[data-summary="weight"]').textContent = productWeight;
      el.querySelector('[data-summary="unit_price"]').textContent = fmt(p.price);
      el.querySelector('[data-summary="qty"]').textContent = 1;
      el.querySelector('[data-summary="line_total"]').textContent = fmt(p.price);
      summary.appendChild(el);

      const shippingCostEl = document.getElementById('shippingCost');
      const shippingCost = parseInt((shippingCostEl?.textContent||'').replace(/\./g,''))||0;
      const total = Number(p.price||0) + shippingCost;
      totalPriceElement.textContent = fmt(total);

      // sinkronkan customerData
      window.customerData.subtotal = Number(p.price||0);
      window.customerData.weight = productWeight;
      if(selectedAddress){ calculateShippingCost(); }
    }

    // Address search & selection
    if(subdistrictInput){
      subdistrictInput.addEventListener('input', function(){
        clearTimeout(debounceTimer);
        const q = this.value.trim();
        if(q.length < 2){ dropdown.classList.add('hidden'); return; }
        debounceTimer = setTimeout(()=> searchAddress(q), 500);
      });
    }

    async function searchAddress(query){
      loadingElement.classList.remove('hidden');
      resultsElement.innerHTML = '';
      dropdown.classList.remove('hidden');
      try{
        const res = await fetch(`${domain}/api/address/search?keyword=${encodeURIComponent(query)}`);
        const data = await res.json();
        if(data.success && Array.isArray(data.data) && data.data.length){ displayResults(data.data); }
        else { resultsElement.innerHTML = '<div class="p-3 text-center text-gray-500">Tidak ada hasil</div>'; }
      } catch(err){ console.error('searchAddress error', err); resultsElement.innerHTML = '<div class="p-3 text-center text-red-500">Terjadi kesalahan</div>'; }
      finally { loadingElement.classList.add('hidden'); }
    }

    function displayResults(addresses){
      resultsElement.innerHTML = addresses.map(addr=>
        `<div onclick="selectAddress('${addr._id}','${addr.SUBDISTRICT_NAME}','${addr.DISTRICT_NAME}','${addr.CITY_NAME}','${addr.PROVINCE_NAME}','${addr.ZIP_CODE||''}')" class="p-3 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-0">${addr.SUBDISTRICT_NAME}, ${addr.DISTRICT_NAME}, ${addr.CITY_NAME}</div>`
      ).join('');
    }

    window.selectAddress = function(id, subdistrict, district, city, province, zipCode){
      selectedAddress = { id, subdistrict, district, city, province, zipCode };
      subdistrictInput.value = `${subdistrict}, ${district}, ${city}`;
      dropdown.classList.add('hidden');
      const addrVal = document.getElementById('address')?.value?.trim()||'';
      // customerData
      Object.assign(window.customerData, { subdistrict, district, city, province, zip_code: zipCode, destination_id: id, address: addrVal, full_address: `${addrVal}, ${subdistrict}, ${district}, ${city}, ${province}` });
      // show courier options
      if(courierGuard) courierGuard.classList.add('hidden');
      if(courierOptions) courierOptions.classList.remove('hidden');
      if(courierLoadingEl) courierLoadingEl.classList.remove('hidden');
      calculateShippingCost();
    }

    async function calculateShippingCost(){
      if(!selectedAddress){
        const shippingInfo = document.getElementById('shippingInfo');
        courierOptions && courierOptions.classList.remove('hidden');
        courierGuard && courierGuard.classList.remove('hidden');
        courierLoadingEl && courierLoadingEl.classList.add('hidden');
        shippingInfo && shippingInfo.classList.add('hidden');
        return;
      }
      try{
        const weight = window.customerData?.weight || productWeight;
        const res = await fetch(`${domain}/api/address/shipping-estimate?origin_id=${originId}&destination_id=${selectedAddress.id}&weight=${weight}`);
        const data = await res.json();
        if(data.success){ displayCourierOptions(data.data); }
      } catch(err){ console.error('calculateShippingCost error', err); }
      finally { courierLoadingEl && courierLoadingEl.classList.add('hidden'); }
    }

    function displayCourierOptions(shippingData){
      const allowedCouriers = ["JNE","JNECargo","SiCepat","SiCepatCargo","SAP","SapCargo","iDexpress","JT","lion","iDexpressCargo","paxel","Ninja"];
      const preSelected = window.customerData?.courier_name || null;
      courierLoadingEl && courierLoadingEl.classList.add('hidden');

      let template = courierList ? courierList.querySelector('#courierItemTemplate') : null;
      if(!template && window.courierItemTemplate){ template = window.courierItemTemplate; }
      if(template){
        window.courierItemTemplate = template;
        Array.from(courierList.children).forEach(child=>{ if(child.id!== 'courierItemTemplate' && child.id!== 'courierLoading') child.remove(); });
      } else { courierList.innerHTML = ''; }

      let hasValid = false;
      Object.entries(shippingData).forEach(([courier, details])=>{
        if(allowedCouriers.includes(courier) && details.price > 0){ hasValid = true; let el; const inputId = `courier-${courier}`;
          if(template){ el = template.cloneNode(true); el.id=''; el.classList.remove('hidden');
            const inputEl = el.querySelector('input[type="radio"]'); const labelEl = el.querySelector('label'); const nameEl = el.querySelector('[data-field="name"]'); const priceEl = el.querySelector('[data-field="price"]'); const etaEl = el.querySelector('[data-field="eta"]');
            if(inputEl){ inputEl.id=inputId; inputEl.name='courier'; inputEl.value=courier; if(preSelected===courier) inputEl.checked=true; }
            if(labelEl) labelEl.setAttribute('for', inputId);
            if(nameEl) nameEl.textContent = courier;
            if(priceEl) priceEl.textContent = `Rp ${fmt(details.price)}`;
            if(etaEl) etaEl.textContent = details.estimatedDate || '-';
            el.addEventListener('click', function(){ if(inputEl) inputEl.checked=true; selectCourier(courier, details.price); });
          } else {
            const div = document.createElement('div'); div.className = 'flex items-center p-3 border-2 border-gray-200 rounded-lg hover:border-teal-300 transition-colors cursor-pointer';
            div.innerHTML = `<input type="radio" id="${inputId}" name="courier" value="${courier}" class="mr-3 w-4 h-4 text-teal-600 focus:ring-teal-500"><label for="${inputId}" class="flex-1 cursor-pointer"><div class="flex justify-between items-center"><span class="font-medium">${courier}</span><span class="text-teal-600 font-semibold">Rp ${fmt(details.price)}</span></div><div class="text-sm text-gray-500">Estimasi: ${details.estimatedDate||'-'}</div></label>`;
            div.addEventListener('click', function(){ document.getElementById(inputId).checked = true; selectCourier(courier, details.price); });
            if(preSelected===courier){ const radio = div.querySelector('input[type="radio"]'); if(radio) radio.checked=true; }
            el = div;
          }
          courierList.appendChild(el);
        }
      });

      if(hasValid){
        courierOptions.classList.remove('hidden');
        if(preSelected && shippingData[preSelected] && shippingData[preSelected].price>0){ selectCourier(preSelected, shippingData[preSelected].price); }
      }
    }

    function selectCourier(courier, price){
      window.customerData.courier_name = courier;
      window.customerData.shipping_cost = price;
      const shippingInfo = document.getElementById('shippingInfo');
      const shippingAddress = document.getElementById('shippingAddress');
      const selectedCourier = document.getElementById('selectedCourier');
      const shippingCost = document.getElementById('shippingCost');
      shippingInfo.classList.remove('hidden');
      shippingAddress.textContent = window.customerData.full_address || window.customerData.address || 'Alamat lengkap';
      selectedCourier.textContent = courier;
      shippingCost.textContent = fmt(price);
      const subtotal = Number(state.product?.price||0);
      const total = subtotal + Number(price||0);
      totalPriceElement.textContent = fmt(total);
      const courierErrorEl = document.getElementById('courierError');
      if(courierErrorEl){ courierErrorEl.classList.add('hidden'); }
    }

    // Submit
    orderForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      // Validasi simple fields
      const formValues = {}; orderForm.querySelectorAll('input,textarea').forEach(el=>{ if(el.name) formValues[el.name] = (el.value||'').trim(); });
      const requiredMissing = []; const raw = document.body.dataset.fields || '{}';
      try{ const parsed = JSON.parse(raw.replace(/'/g,'"')); const fields = Array.isArray(parsed.fields)?parsed.fields:[]; fields.forEach(f=>{ const v = formValues[f.id]||''; if(f.required && !v) requiredMissing.push(f.label||f.id); }); } catch{}
      if(requiredMissing.length){ alert('Mohon lengkapi field wajib: ' + requiredMissing.join(', ')); return; }
      if(!selectedAddress){ alert('Mohon pilih desa/kelurahan'); return; }
      if(!window.customerData?.courier_name){ document.getElementById('courierError').classList.remove('hidden'); return; }

      // Build payload
      const p = state.product; const subtotal = Number(p?.price||0); const shipping = Number(window.customerData?.shipping_cost||0); const total = subtotal + shipping;
      window.customerData.subtotal = subtotal; window.customerData.weight = productWeight;
      const payload = { originId, items:[{ id:p.id, name:p.name, price: subtotal, quantity:1 }], customer: { ...formValues, ...window.customerData }, total };

      // Feedback sukses & redirect preview
      successMessage.classList.remove('hidden');
      setTimeout(()=>{ successContent.classList.remove('opacity-0'); successContent.classList.remove('scale-95'); }, 20);
      let progress = 0; const timer = setInterval(()=>{ progress = Math.min(100, progress + 5); progressBar.style.width = progress + '%'; if(progress>=100){ clearInterval(timer); if(domain){ setTimeout(()=>{ window.location.href = domain + '/checkout?ref=' + encodeURIComponent(originId); }, 600); } } }, 80);
      console.log('Order Payload (PF Single Product):', payload);
    });
  </script>
</body>
</html>
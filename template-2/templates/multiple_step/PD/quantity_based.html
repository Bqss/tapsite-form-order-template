
<section
  class="min-h-screen bg-gradient-to-br from-teal-50 via-emerald-50 to-cyan-50">

  <!-- Header + Stepper -->
  <div class="px-4 py-10 sm:px-6 lg:px-8">
    <div class="max-w-6xl mx-auto">
      <div class="rounded-3xl bg-gradient-to-b from-teal-700 to-emerald-600 text-white p-6 sm:p-8 shadow-xl">
        <h1 class="text-3xl font-extrabold tracking-tight">Order Form • Produk Digital (Quantity Based) • Multi-step</h1>
        <p class="mt-2 opacity-90">Konfirmasi produk, lengkapi data pemesan, dan cek ringkasan.</p>
        <div class="mt-6">
          <div class="w-full bg-white/20 rounded-full h-2">
            <div id="stepProgressBar" class="bg-white h-2 rounded-full transition-all duration-500" style="width:33%"></div>
          </div>
          <div class="mt-3 grid grid-cols-3 gap-1.5 sm:gap-2 text-xs sm:text-sm">
            <div data-step-index="1" class="flex flex-col sm:flex-row items-center gap-1 sm:gap-2 px-2 sm:px-3 py-2 rounded-lg bg-white text-teal-800 ring-2 ring-white/70 shadow-md scale-[1.02] font-semibold">
              <span class="flex h-5 w-5 sm:h-6 sm:w-6 items-center justify-center rounded-full bg-white text-teal-700 font-bold text-xs sm:text-sm">1</span>
              <span class="text-[10px] sm:text-xs">Produk</span>
            </div>
            <div data-step-index="2" class="flex flex-col sm:flex-row items-center gap-1 sm:gap-2 px-2 sm:px-3 py-2 rounded-lg bg-white/10 text-white/80 opacity-80">
              <span class="flex h-5 w-5 sm:h-6 sm:w-6 items-center justify-center rounded-full bg-white/70 text-teal-800 font-semibold text-xs sm:text-sm">2</span>
              <span class="text-[10px] sm:text-xs">Pemesan</span>
            </div>
            <div data-step-index="3" class="flex flex-col sm:flex-row items-center gap-1 sm:gap-2 px-2 sm:px-3 py-2 rounded-lg bg-white/10 text-white/80 opacity-80">
              <span class="flex h-5 w-5 sm:h-6 sm:w-6 items-center justify-center rounded-full bg-white/70 text-teal-800 font-semibold text-xs sm:text-sm">3</span>
              <span class="text-[10px] sm:text-xs hidden sm:inline">Ringkasan</span>
              <span class="text-[10px] sm:hidden">Done</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main content: three steps -->
  <div class="px-4 pb-12 sm:px-6 lg:px-8">
    <div class="max-w-6xl mx-auto">
      <form id="orderForm" class="space-y-6">
        <!-- Step 1: Product selection -->
        <div data-step="1" id="step-1" class="bg-white rounded-3xl shadow-xl ring-1 ring-teal-100 p-6 sm:p-8">
          <div class="flex items-start justify-between gap-4">
            <div>
              <h2 class="text-xl font-bold text-gray-900">Pilih cupcake favoritmu</h2>
              <p class="text-sm text-gray-600 mt-1">Tambahkan jumlah untuk setiap produk yang kamu inginkan.</p>
            </div>
            <div id="step1Alert" class="hidden text-sm px-3 py-2 bg-red-50 text-red-700 border border-red-200 rounded-lg">Pilih minimal satu produk untuk lanjut.</div>
          </div>

          <div id="products" class="mt-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 sm:gap-3">
            <!-- Template Card Produk (no <template> tag) -->
            <div data-role="product" data-template="product" class="group bg-gradient-to-br from-white to-teal-50 border border-teal-100 rounded-2xl overflow-hidden shadow-sm transition-all">
              <div class="p-2 sm:p-3">
                <!-- Mobile: row, Desktop: column -->
                <div class="flex items-start gap-2 sm:block">
                  <!-- Thumbnail more compact on mobile -->
                  <div class="w-14 h-14 sm:w-auto sm:h-auto sm:aspect-square rounded-lg sm:rounded-xl overflow-hidden bg-teal-100">
                    <img data-value="image_url" src="https://imageio.forbes.com/specials-images/imageserve/65df2e0562b5d061b718a4af/0x0.jpg?format=jpg&height=900&width=1600&fit=bounds" alt="Cupcake" class="w-full h-full object-cover sm:group-hover:scale-105 transition-transform duration-300" />
                  </div>
                  <div class="flex-1 sm:mt-2">
                    <h3 class="text-sm sm:text-base font-bold text-gray-900" data-value="name">Nama Produk</h3>
                    <p class="text-[11px] sm:text-sm text-gray-600 line-clamp-2 sm:line-clamp-none" data-value="description">Deskripsi singkat produk.</p>
                    <div class="mt-2 sm:mt-3 flex items-center justify-between">
                      <span class="text-sm sm:text-lg font-extrabold text-teal-700" data-value="price">Rp 0</span>
                      <div class="flex items-center gap-1 sm:gap-2">
                        <button type="button" id="decreaseQty" class="w-6 h-6 sm:w-8 sm:h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center transition-colors">
                          <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3 sm:w-3.5 sm:h-3.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/></svg>
                        </button>
                        <input type="number" id="quantity" value="0" min="0" class="w-10 h-7 sm:w-12 sm:h-8 text-center border-2 border-gray-200 rounded-lg focus:border-teal-500 focus:outline-none text-xs" />
                        <button type="button" id="increaseQty" class="w-6 h-6 sm:w-8 sm:h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center transition-colors">
                          <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3 sm:w-3.5 sm:h-3.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/></svg>
                        </button>
                      </div>
                    </div>
                    <p class="mt-1 sm:mt-2 text-[10px] sm:text-xs text-gray-500">Berat: 200g per item</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Step navigation -->
          <div class="mt-6 flex items-center justify-end gap-3">
            <button type="button" id="nextToStep2" class="px-6 py-3 bg-gradient-to-r from-teal-600 to-cyan-600 text-white font-bold rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-teal-500">Lanjut ke Data Pemesan</button>
          </div>
        </div>

        <!-- Step 2: Customer information -->
        <div data-step="2" id="step-2" class="hidden bg-white rounded-3xl shadow-xl ring-1 ring-teal-100 p-6 sm:p-8">
          <div class="flex items-start justify-between gap-4">
            <div>
              <h2 class="text-xl font-bold text-gray-900">Detail Pemesan</h2>
              <p class="text-sm text-gray-600 mt-1">Lengkapi informasi di bawah ini.</p>
            </div>
            <div id="step2Alert" class="hidden text-sm px-3 py-2 bg-red-50 text-red-700 border border-red-200 rounded-lg">Lengkapi semua field yang wajib.</div>
          </div>

          <div id="forms" class="mt-4 grid grid-cols-1 gap-4">
            <!-- Template Field -->
            <div data-role="field" data-template="field" class="space-y-2">
              <label for="name" class="block text-sm font-medium text-gray-700" data-value="label">Nama <span class="text-red-500">*</span></label>
              <input type="text" id="name" name="name" required data-value-id data-value-type data-value-required class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all" placeholder="Masukkan nama lengkap" />
            </div>
          </div>

          <!-- Step navigation -->
          <div class="mt-6 flex items-center justify-between gap-3">
            <button type="button" id="backToStep1" class="px-6 py-3 bg-gray-100 text-gray-800 font-semibold rounded-lg hover:bg-gray-200 transition-colors">Kembali</button>
            <button type="button" id="nextToStep3" class="px-6 py-3 bg-gradient-to-r from-teal-600 to-cyan-600 text-white font-bold rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-teal-500">Lanjut ke Ringkasan</button>
          </div>
        </div>

        <!-- Step 3: Order summary & submit -->
        <div data-step="3" id="step-3" class="hidden bg-white rounded-3xl shadow-xl ring-1 ring-teal-100 p-6 sm:p-8">
          <h2 class="text-2xl font-bold text-gray-900">Ringkasan Pesanan</h2>
          <p class="text-sm text-gray-600 mt-1">Periksa kembali pesananmu sebelum menyelesaikan.</p>

          <div data-role="parent" class="mt-4">
            <div class="bg-gradient-to-br from-white to-cyan-50 rounded-2xl p-4 border border-teal-100">
              <div id="summaryItems" class="space-y-3"></div>

              <!-- Template summary item -->
              <div id="summaryItemTemplate" data-template="summary-item" data-role="summary-item" data-placeholder="true" class="hidden">
                <div class="flex items-center justify-between pb-3 border-b border-teal-100">
                  <div>
                    <h3 class="font-semibold text-gray-900" data-summary="name">Nama Produk</h3>
                    <p class="text-xs text-gray-500">Berat: <span data-summary="weight">200</span>g</p>
                  </div>
                  <div class="text-right">
                    <p class="text-sm text-gray-600">Rp <span data-summary="unit_price">0</span> × <span data-summary="qty">0</span></p>
                    <p class="font-semibold text-gray-900">Rp <span data-summary="line_total">0</span></p>
                  </div>
                </div>
              </div>

              <div class="flex items-center justify-between pt-2">
                <h3 class="text-lg font-bold text-gray-900">Total</h3>
                <p class="text-xl font-extrabold text-teal-700">Rp <span id="totalPrice">0</span></p>
              </div>
            </div>
          </div>

          <!-- Trust & Submit -->
          <div class="mt-6">
            <div class="flex flex-wrap items-center justify-center gap-4 text-sm text-gray-500">
              <div class="flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-emerald-500 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>Pembayaran Aman</div>
              <div class="flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-emerald-500 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/></svg>Data Terenkripsi</div>
            </div>
          </div>

          <div class="mt-6 flex items-center justify-between gap-3">
            <button type="button" id="backToStep2" class="px-6 py-3 bg-gray-100 text-gray-800 font-semibold rounded-lg hover:bg-gray-200 transition-colors">Kembali</button>
            <button type="submit" id="submitBtn" class="px-8 py-4 bg-gradient-to-r from-teal-600 to-cyan-600 text-white font-bold rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2">Selesaikan Pesanan</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Success Modal -->
  <div id="successMessage" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
    <div id="successContent" class="bg-white rounded-2xl p-8 max-w-md mx-4 transform transition-all duration-300 scale-95 opacity-0">
      <div class="text-center">
        <div class="w-16 h-16 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-emerald-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
        </div>
        <h3 class="text-xl font-bold text-gray-900 mb-2">Pesanan Berhasil!</h3>
        <p class="text-gray-600 mb-6">Terima kasih. Kamu akan diarahkan ke halaman pembayaran.</p>
        <div class="w-full bg-gray-200 rounded-full h-2">
          <div class="bg-teal-600 h-2 rounded-full" id="progressBar" style="width:0%"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Konstanta domain & konfigurasi
    const domain = document.body.dataset.domain || '';
    const originId = document.body.dataset.originId || '';
    const productWeight = 200; // gram per item

    // Step state
    let currentStep = 1;
    const totalSteps = 3;

    // Elemen step & progress
    const step1 = document.getElementById('step-1');
    const step2 = document.getElementById('step-2');
    const step3 = document.getElementById('step-3');
    const stepProgressBar = document.getElementById('stepProgressBar');

    const nextToStep2 = document.getElementById('nextToStep2');
    const nextToStep3 = document.getElementById('nextToStep3');
    const backToStep1 = document.getElementById('backToStep1');
    const backToStep2 = document.getElementById('backToStep2');
    const step1Alert = document.getElementById('step1Alert');
    const step2Alert = document.getElementById('step2Alert');

    // Elemen kontainer konten
    const productsContainer = document.getElementById('products');
    const summaryItemsContainer = document.getElementById('summaryItems');
    const summaryItemTemplate = document.getElementById('summaryItemTemplate');
    const totalPriceElement = document.getElementById('totalPrice');

    const orderForm = document.getElementById('orderForm');
    const submitBtn = document.getElementById('submitBtn');
    const successMessage = document.getElementById('successMessage');
    const successContent = document.getElementById('successContent');
    const progressBar = document.getElementById('progressBar');

    // Render Produk Dinamis berbasis template
    (function initProductRendering() {
      try {
        const raw = document.body.dataset.products || '[]';
        const products = JSON.parse(raw.replace(/'/g, '"'));

        const template = productsContainer ? productsContainer.querySelector('[data-role="product"]') : null;
        if (!productsContainer || !template || !Array.isArray(products)) return;

        const buildProductHTML = (product) => {
          const el = template.cloneNode(true);

          // Isi data visual
          const imgEl = el.querySelector('[data-value="image_url"]') || el.querySelector('img');
          if (imgEl) {
            if (product.image_url) imgEl.src = product.image_url;
            imgEl.alt = product.name || 'Produk';
          }

          el.querySelectorAll('[data-value="name"]').forEach(n => n.textContent = product.name || '');
          const descEl = el.querySelector('[data-value="description"]');
          if (descEl) descEl.textContent = product.description || '';

          const priceEl = el.querySelector('[data-value="price"]');
          const priceNum = typeof product.price === 'number' ? product.price : parseInt(product.price, 10) || 0;
          if (priceEl) priceEl.textContent = 'Rp ' + priceNum.toLocaleString('id-ID');

          // Quantity awal 0
          const qtyEl = el.querySelector('#quantity');
          if (qtyEl) qtyEl.value = 0;

          el.setAttribute('data-product-id', product.id || '');
          return el.outerHTML;
        };

        productsContainer.innerHTML = products.map(buildProductHTML).join('');

        // Persist state
        window.productsData = products.map(p => ({ ...p, quantity: 0 }));

        // Pasang event handler
        attachProductEvents();
        updateSummary();
      } catch (err) {
        console.warn('Gagal render produk:', err);
      }
    })();

    function attachProductEvents() {
      const cards = productsContainer.querySelectorAll('[data-role="product"]');
      cards.forEach(card => {
        const productId = card.getAttribute('data-product-id');
        const idx = window.productsData.findIndex(p => p.id === productId);
        if (idx < 0) return;

        const decBtn = card.querySelector('#decreaseQty');
        const incBtn = card.querySelector('#increaseQty');
        const qtyEl = card.querySelector('#quantity');

        const setQty = (val) => {
          const v = Math.max(0, parseInt(val || 0, 10));
          qtyEl.value = v;
          window.productsData[idx].quantity = v;
          updateSummary();
        };

        decBtn && decBtn.addEventListener('click', () => setQty(parseInt(qtyEl.value, 10) - 1));
        incBtn && incBtn.addEventListener('click', () => setQty(parseInt(qtyEl.value, 10) + 1));
        qtyEl && qtyEl.addEventListener('input', () => setQty(qtyEl.value));
      });
    }

    // Render Field Dinamis berbasis template
    (function initFieldRendering() {
      try {
        const raw = document.body.dataset.fields || '{}';
        const parsed = JSON.parse(raw.replace(/'/g, '"'));
        const fields = Array.isArray(parsed.fields) ? parsed.fields : [];

        const container = document.getElementById('forms');
        const template = container ? container.querySelector('[data-role="field"]') : null;
        if (!container || !template || !fields.length) return;

        const buildFieldHTML = (field) => {
          const el = template.cloneNode(true);

          const labelEl = el.querySelector('[data-value="label"]') || el.querySelector('label');
          const inputEl = el.querySelector('input');

          if (labelEl) labelEl.textContent = field.label || field.id || 'Field';
          if (inputEl) {
            inputEl.type = field.type || 'text';
            inputEl.id = field.id || field.label?.toLowerCase()?.replace(/\s+/g, '-') || 'field';
            inputEl.name = inputEl.id;
            inputEl.required = !!field.required;
            inputEl.placeholder = field.placeholder || 'Isi ' + (field.label || 'data');
          }

          return el.outerHTML;
        };

        container.innerHTML = fields.map(buildFieldHTML).join('');
      } catch (e) {
        console.warn('Gagal render fields:', e);
      }
    })();

    // Ringkasan pesanan
    function updateSummary() {
      if (!summaryItemsContainer || !summaryItemTemplate) return;
      summaryItemsContainer.innerHTML = '';

      let total = 0;
      window.productsData.forEach(p => {
        const qty = parseInt(p.quantity || 0, 10);
        const price = typeof p.price === 'number' ? p.price : parseInt(p.price, 10) || 0;
        if (qty > 0) {
          const line = price * qty;
          total += line;

          const el = summaryItemTemplate.cloneNode(true);
          el.classList.remove('hidden');
          el.removeAttribute('data-placeholder');

          const nameEl = el.querySelector('[data-summary="name"]');
          const wEl = el.querySelector('[data-summary="weight"]');
          const upEl = el.querySelector('[data-summary="unit_price"]');
          const qtyEl = el.querySelector('[data-summary="qty"]');
          const lineEl = el.querySelector('[data-summary="line_total"]');

          if (nameEl) nameEl.textContent = p.name || '';
          if (wEl) wEl.textContent = productWeight;
          if (upEl) upEl.textContent = (price).toLocaleString('id-ID');
          if (qtyEl) qtyEl.textContent = qty;
          if (lineEl) lineEl.textContent = line.toLocaleString('id-ID');

          summaryItemsContainer.appendChild(el);
        }
      });

      totalPriceElement.textContent = total.toLocaleString('id-ID');
    }

    // Validations
    function hasSelectedProducts() {
      return Array.isArray(window.productsData) && window.productsData.some(p => parseInt(p.quantity || 0, 10) > 0);
    }

    function validateStep1() {
      const ok = hasSelectedProducts();
      step1Alert.classList.toggle('hidden', ok);
      return ok;
    }

    function validateStep2() {
      let ok = true;
      step2Alert.classList.add('hidden');
      orderForm.querySelectorAll('#step-2 input').forEach(inp => {
        inp.classList.remove('ring-2', 'ring-red-500');
        if (inp.required && !inp.value?.trim()) {
          ok = false;
          inp.classList.add('ring-2', 'ring-red-500');
        }
      });
      step2Alert.classList.toggle('hidden', ok);
      return ok;
    }

    // Stepper controls
    function setStep(step) {
      currentStep = Math.max(1, Math.min(totalSteps, step));

      // Show/Hide step content
      step1.classList.toggle('hidden', currentStep !== 1);
      step2.classList.toggle('hidden', currentStep !== 2);
      step3.classList.toggle('hidden', currentStep !== 3);

      // Update progress bar
      const pct = currentStep === 1 ? 33 : currentStep === 2 ? 66 : 100;
      if (stepProgressBar) stepProgressBar.style.width = pct + '%';

      // Update step indicators
      document.querySelectorAll('[data-step-index]').forEach(el => {
        const s = parseInt(el.getAttribute('data-step-index'), 10);
        const numberSpan = el.querySelector('span:first-child');
        
        if (s === currentStep) {
          el.className = 'flex flex-col sm:flex-row items-center gap-1 sm:gap-2 px-2 sm:px-3 py-2 rounded-lg bg-white text-teal-800 ring-2 ring-white/70 shadow-md scale-[1.02] font-semibold';
          if (numberSpan) numberSpan.className = 'flex h-5 w-5 sm:h-6 sm:w-6 items-center justify-center rounded-full bg-white text-teal-700 font-bold text-xs sm:text-sm';
        } else if (s < currentStep) {
          el.className = 'flex flex-col sm:flex-row items-center gap-1 sm:gap-2 px-2 sm:px-3 py-2 rounded-lg bg-white/30 text-white opacity-90';
          if (numberSpan) numberSpan.className = 'flex h-5 w-5 sm:h-6 sm:w-6 items-center justify-center rounded-full bg-white/70 text-teal-800 font-semibold text-xs sm:text-sm';
        } else {
          el.className = 'flex flex-col sm:flex-row items-center gap-1 sm:gap-2 px-2 sm:px-3 py-2 rounded-lg bg-white/10 text-white/80 opacity-80';
          if (numberSpan) numberSpan.className = 'flex h-5 w-5 sm:h-6 sm:w-6 items-center justify-center rounded-full bg-white/70 text-teal-800 font-semibold text-xs sm:text-sm';
        }
      });
    }

    // Navigation events
    nextToStep2?.addEventListener('click', () => {
      if (!validateStep1()) return;
      setStep(2);
    });
    backToStep1?.addEventListener('click', () => setStep(1));

    nextToStep3?.addEventListener('click', () => {
      if (!validateStep2()) return;
      // Update summary once more before showing
      updateSummary();
      setStep(3);
    });
    backToStep2?.addEventListener('click', () => setStep(2));

    // Initial step
    setStep(1);

    // Submit Handling
    orderForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      // Ambil data form
      const formValues = {};
      orderForm.querySelectorAll('input').forEach(inp => {
        formValues[inp.name] = inp.value;
      });

      const orderItems = (window.productsData || []).filter(p => (parseInt(p.quantity || 0, 10) > 0));
      if (orderItems.length === 0) { alert('Pilih minimal 1 produk'); setStep(1); return; }

      const itemsForSubmit = orderItems.map(p => ({
        id: p.id,
        code: p.id,
        name: p.name,
        price: Number(p.price||0),
        quantity: parseInt(p.quantity, 10),
        is_addon: !!p.is_addon
      }));
      const subtotal = orderItems.reduce((sum, p) => sum + (Number(p.price||0) * parseInt(p.quantity, 10)), 0);
      const total = subtotal;

      const urlParams = new URLSearchParams(window.location.search);
      const utm = { utm_source: urlParams.get('utm_source')||'', utm_medium: urlParams.get('utm_medium')||'', utm_campaign: urlParams.get('utm_campaign')||'', utm_content: urlParams.get('utm_content')||'' };
      const submissionData = { customer_data: { ...formValues, utm_meta: utm }, subtotal, total, product: itemsForSubmit };

      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true; submitBtn.textContent = 'Memproses...'; submitBtn.classList.add('opacity-75','cursor-not-allowed');
      try{
        const response = await fetch(`${domain}/form/${document.body.dataset.formId}`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(submissionData) });
        const result = await response.json();
        if (result.id){ successMessage.classList.remove('hidden'); setTimeout(()=>{ successContent.classList.remove('scale-95','opacity-0'); successContent.classList.add('scale-100','opacity-100'); let width=0; const interval=setInterval(()=>{ width+=10; progressBar.style.width=width+'%'; if (width>=100){ clearInterval(interval); window.location.href = `${domain}/invoice/${result.id}`; } },100); },100); }
        else { throw new Error('Failed to submit order'); }
      } catch(err){ console.error('Error submitting order:', err); alert('Terjadi kesalahan saat mengirim pesanan. Silakan coba lagi.'); submitBtn.disabled=false; submitBtn.textContent='Selesaikan Pesanan'; submitBtn.classList.remove('opacity-75','cursor-not-allowed'); }
    });
  </script>
</sectionƒ>

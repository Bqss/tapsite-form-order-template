<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script src="https://cdn.tailwindcss.com/3.4.16"></script>
</head>

<body
  data-products='[{"id":"KPRI01","name":"Friendly Business Access (UMKM Oriented)","price":197000,"discount_price":0,"description":"Cocok Untuk: Pemilik UMKM, pemula, pengguna paket basic Dripsender\n\nValue Proposisi:\n\n- Konsultasi ringan & edukatif\n- Fokus pada audit WhatsApp Marketing, optimasi LP, dan funnel basic\n- Dapat dilakukan di cafÃ© dengan suasana santai","image_url":"https://storage.tapsite.ai/media/assets/01966a89-f870-7-9e0f-687626ed3a99dd3a.webp","is_addon":false,"quantity":0,"is_required":false,"allow_custom_price":false,"imageLoading":false},{"id":"KPRI02","name":"Strategi Bisnis Menengah (Growth Oriented)","price":397000,"description":"Cocok Untuk: Pemilik bisnis yang sudah aktif tapi belum optimal secara digital\n\nValue Proposisi:\n\n- Business funnel diagnosis\n- Strategi konten, autoresponder, closing script\n- Termasuk review LP dan automation sequence","image_url":"https://storage.tapsite.ai/media/assets/01966a8b-519f-7-9516-b2a867fa3a7d79bc.webp","is_addon":false,"quantity":0,"is_required":false,"allow_custom_price":false,"imageLoading":false},{"id":"KPRI03","name":"VIP Strategic Session (High Ticket)","price":897000,"description":"Cocok Untuk: Pebisnis skala besar, agency, atau pengguna langganan premium\n\nValue Proposisi:\n\n- Analisis mendalam berbasis data\n- Blueprint strategi growth WhatsApp + LP funnel\n- Follow-up report tertulis (opsional), dan bisa 1-on-1 langsung dengan expert","image_url":"https://storage.tapsite.ai/media/assets/01966a8c-e432-7-92b2-0b2f685ad2055a34.webp","is_addon":false,"quantity":0,"is_required":false,"allow_custom_price":false,"imageLoading":false}]'
  data-fields='{"fields":[{"id":"name","label":"Nama","type":"text","required":true},{"id":"email","label":"Email","type":"email","required":false},{"id":"phone","label":"Nomor Telepon","type":"tel","required":true}]}'
  data-couriers='["JNE","JNECargo","SiCepat","SiCepatCargo","SAP","SapCargo","iDexpress","JT","lion","iDexpressCargo","paxel","Ninja"]'
  data-domain="http://localhost:5556" data-origin-id="5fc63944f8f44b34aa4c819e">
  <section class="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 py-8 px-4 sm:px-6 lg:px-8">
    <div class="w-full max-w-sm sm:max-w-md md:max-w-2xl lg:max-w-3xl mx-auto">
      <!-- Header -->
      <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Form order A</h1>
        <p class="text-gray-600">Beli produk anda disini</p>
      </div>

      <!-- Form Container -->
      <div class="bg-white rounded-2xl shadow-xl overflow-hidden">

        <form id="orderForm" class="p-6 sm:p-8 lg:p-10">
          <!-- Stepper UI (aligned to single_product/form_ms.html) -->
          <div id="ms-stepper" class="flex items-center justify-between mb-6">
            <div class="flex-1 flex items-center">
              <div class="step-node" data-step-index="0">
                <div class="w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm bg-blue-100 text-blue-600">1</div>
                <div class="text-xs mt-1 text-gray-700">Produk</div>
              </div>
              <div class="flex-1 h-0.5 mx-2 bg-gray-200"></div>
              <div class="step-node" data-step-index="1">
                <div class="w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm bg-gray-100 text-gray-500">2</div>
                <div class="text-xs mt-1 text-gray-700">Identitas</div>
              </div>
              <div class="flex-1 h-0.5 mx-2 bg-gray-200"></div>
              <div class="step-node" data-step-index="2">
                <div class="w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm bg-gray-100 text-gray-500">3</div>
                <div class="text-xs mt-1 text-gray-700">Pengiriman</div>
              </div>
              <div class="flex-1 h-0.5 mx-2 bg-gray-200"></div>
              <div class="step-node" data-step-index="3">
                <div class="w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm bg-gray-100 text-gray-500">4</div>
                <div class="text-xs mt-1 text-gray-700">Ringkasan</div>
              </div>
            </div>
          </div>

          <!-- Step 1: Product Selection -->
          <section class="step-section" data-step="1">
            <div data-role="parent" class="mb-8 sm:mb-10">
              <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                <span class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold text-sm mr-2">1</span>
                Pilih Produk
              </h2>
              <div class="flex flex-col gap-4" id="products">
                <div class="bg-white rounded-xl p-4 border-2 border-transparent transition-all duration-300 cursor-pointer shadow-md hover:shadow-lg hover:border-blue-500" data-role="product" data-template="product">
                  <div class="flex flex-row gap-4 items-center">
                      <div class="flex-shrink-0">
                          <img data-value="image_url" src="https://placehold.co/300x300/e2e8f0/64748b?text=Produk" alt="Produk" class="w-24 h-24 object-cover rounded-lg shadow-md border border-gray-200">
                      </div>
                      <div class="w-full min-w-0">
                          <div class="flex justify-between items-start mb-1">
                              <h3 class="text-lg font-bold text-gray-900" data-value="name">Nama Produk</h3>
                              <div class="w-6 h-6 bg-white rounded-full border-2 border-gray-300 flex items-center justify-center transition-all duration-300 flex-shrink-0 ml-4">
                                  <div class="w-3 h-3 bg-blue-500 rounded-full transform scale-0 transition-all duration-300"></div>
                              </div>
                          </div>
                          <p class="text-sm text-gray-500 mt-1 truncate" data-value="description">Deskripsi</p>
                          <div class="flex items-center justify-between mt-3">
                              <div class="text-lg font-bold text-blue-600 flex items-center gap-2">
                                <span>Rp</span>
                                <input type="number" data-role="price-input" min="0" step="100" class="w-28 px-2 py-1 border border-blue-200 rounded bg-blue-50 text-blue-700 font-semibold focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="0" />
                              </div>
                              <span class="text-sm text-gray-500">200g</span>
                          </div>
                      </div>
                      <input type="radio" name="product_selection" class="hidden">
                  </div>
                </div>
              </div>
            </div>
            <div class="flex justify-end gap-3">
              <button type="button" class="px-4 py-2 rounded-lg bg-blue-600 text-white" data-action="next">Lanjut</button>
            </div>
          </section>

          <!-- Step 2: Identity -->
          <section class="step-section hidden" data-step="2">
            <div data-role="parent" class="mb-8 sm:mb-10">
              <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                <span class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold text-sm mr-2">2</span>
                Informasi Identitas
              </h2>
              <div class="space-y-6" id="forms">
                <div data-role="field" data-template="field">
                  <label for="name" class="block text-base sm:text-sm font-medium text-gray-700 mb-2" data-value="label">Nama <span class="text-red-500">*</span></label>
                  <input type="text" id="name" name="name" required class="w-full px-4 py-4 sm:py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-base" placeholder="Masukkan nama lengkap Anda">
                </div>
              </div>
            </div>
            <div class="flex justify-between gap-3">
              <button type="button" class="px-4 py-2 rounded-lg bg-gray-200" data-action="prev">Kembali</button>
              <button type="button" class="px-4 py-2 rounded-lg bg-blue-600 text-white" data-action="next">Lanjut</button>
            </div>
          </section>

          <!-- Step 3: Shipping -->
          <section class="step-section hidden" data-step="3">
            <div data-role="parent" class="mb-8 sm:mb-10">
              <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                <span class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold text-sm mr-2">3</span>
                Informasi Pengiriman
              </h2>
              <div class="space-y-6">
                <div class="relative">
                  <label for="subdistrict" class="block text-base sm:text-sm font-medium text-gray-700 mb-2">Desa/Kelurahan <span class="text-red-500">*</span></label>
                  <input type="text" id="subdistrict" name="subdistrict" required class="w-full px-4 py-4 sm:py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-base" placeholder="Ketik nama desa/kelurahan...">
                  <div id="dropdown" class="absolute bottom-full left-0 right-0 bg-white border-2 border-gray-200 rounded-lg shadow-lg z-50 max-h-60 overflow-y-auto hidden w-full mb-2">
                    <div id="loading" class="p-3 text-center hidden" data-placeholder="true">Mencari...</div>
                    <div id="results"></div>
                  </div>
                  <div class="mt-5">
                    <label for="address" class="block text-base sm:text-sm font-medium text-gray-700 mb-2">Alamat Lengkap <span class="text-red-500">*</span></label>
                    <textarea id="address" name="address" rows="3" required class="w-full px-4 py-4 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-base" placeholder="Nama jalan, nomor rumah, RT/RW, patokan"></textarea>
                  </div>
                </div>

                <div id="courierOptions">
                  <label class="block text-base sm:text-sm font-medium text-gray-700 mb-2">Pilih Kurir <span class="text-red-500">*</span></label>
                  <div id="courierGuard" class="mb-3 p-3 border-2 border-dashed border-gray-300 rounded-lg text-center text-sm text-gray-600" data-placeholder="true">Pilih alamat terlebih dahulu untuk melihat pilihan kurir dan menghitung ongkir.</div>
                  <div id="courierList" class="space-y-3 grid grid-cols-2 gap-2">
                    <div id="courierLoading" class="col-span-2 p-3 border-2 border-gray-200 rounded-lg text-gray-600 text-sm flex items-center gap-2 hidden" data-placeholder="true">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 animate-spin text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a7 7 0 100 14v-2a5 5 0 110-10V3z" clip-rule="evenodd"></path></svg>
                      <span>Sedang menghitung ongkir dan mengambil daftar kurir...</span>
                    </div>
                    <div id="courierItemTemplate" data-role="courier-item" data-template="courier-item" data-placeholder="true" class="flex items-center p-3 border-2 border-gray-200 rounded-lg hover:border-blue-300 transition-colors cursor-pointer hidden">
                      <input type="radio" name="courier" class="mr-3 w-4 h-4 text-blue-600 focus:ring-blue-500" />
                      <label class="flex-1 cursor-pointer">
                        <div class="flex justify-between items-center">
                          <span class="font-medium" data-field="name">Nama Kurir</span>
                          <span class="text-blue-600 font-semibold" data-field="price">Rp 0</span>
                        </div>
                        <div class="text-sm text-gray-500">Estimasi: <span data-field="eta">2-3 Hari</span></div>
                      </label>
                    </div>
                  </div>
                  <div id="courierError" class="mt-2 text-red-500 text-sm hidden">Silakan pilih kurir pengiriman</div>
                </div>
              </div>
            </div>
            <div class="flex justify-between gap-3">
              <button type="button" class="px-4 py-2 rounded-lg bg-gray-200" data-action="prev">Kembali</button>
              <button type="button" class="px-4 py-2 rounded-lg bg-blue-600 text-white" data-action="next">Lanjut</button>
            </div>
          </section>

          <!-- Step 4: Summary -->
          <section class="step-section hidden" data-step="4">
            <div data-role="parent" class="mb-8 sm:mb-10">
              <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                <span class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold text-sm mr-2">4</span>
                Ringkasan Pesanan
              </h2>
              <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 border border-blue-100">
                <div class="space-y-4">
                  <div id="summaryItems" class="space-y-3"></div>
                  <div id="summaryItemTemplate" data-template="summary-item" data-role="summary-item" class="flex justify-between items-center pb-3 border-b border-blue-100 hidden">
                    <div>
                      <h3 class="font-semibold text-gray-900" data-summary="name">Test</h3>
                      <p class="text-sm text-gray-500">Berat: <span data-summary="weight">1000</span>g</p>
                    </div>
                    <div class="text-right">
                      <p class="font-semibold text-gray-900">Rp <span data-summary="line_total">0</span></p>
                    </div>
                  </div>

                  <div id="shippingInfo" class="hidden">
                    <div class="pb-3 border-b border-blue-100">
                      <h4 class="font-medium text-gray-900 mb-2">Informasi Pengiriman</h4>
                      <p class="text-sm text-gray-600" id="shippingAddress"></p>
                      <p class="text-sm text-gray-600 mt-1">Kurir: <span id="selectedCourier">jne</span></p>
                      <p class="text-sm text-gray-600">Ongkos Kirim: Rp <span id="shippingCost">0</span></p>
                    </div>
                  </div>

                  <div class="flex justify-between items-center ">
                    <h3 class="text-lg font-bold text-gray-900">Total</h3>
                    <p class="text-xl font-bold text-blue-600">Rp <span id="totalPrice">20.000</span></p>
                  </div>
                </div>
              </div>
            </div>
            <div class="flex justify-between gap-3">
              <button type="button" class="px-4 py-2 rounded-lg bg-gray-200" data-action="prev">Kembali</button>
              <button type="submit" id="submitBtn" class="px-8 py-4 bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-bold rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300">Selesaikan Pesanan</button>
            </div>
          </section>
        </form>
      </div>

      <!-- Success Message -->
      <div id="successMessage" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-md mx-4 transform transition-all duration-300 scale-95 opacity-0" id="successContent">
          <div class="text-center">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-500" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
              </svg>
            </div>
            <h2 class="text-2xl font-bold text-gray-900 mb-2">Pesanan Berhasil!</h2>
            <p class="text-gray-600 mb-6">Terima kasih! Pesanan Anda telah kami terima dan akan segera diproses.</p>
            <a href="#" id="backToHome" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors">Kembali ke Halaman Utama</a>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Scripts: original logic preserved -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const state = {
        products: [],
        fields: [],
        couriers: [],
        selectedSubdistrict: null,
        selectedCourier: null,
        formValues: {},
        totalWeight: 0,
        totalPrice: 0,
        shippingCost: 0,
      };

      function formatCurrency(amount) {
        return new Intl.NumberFormat('id-ID').format(amount);
      }

      function getElementData(element, key) {
        return element.dataset[key];
      }

      function initializeData() {
        const body = document.body;
        state.products = JSON.parse(getElementData(body, 'products'));
        state.fields = JSON.parse(getElementData(body, 'fields')).fields;
        state.couriers = JSON.parse(getElementData(body, 'couriers'));
      }

      function renderProducts() {
        const productContainer = document.getElementById('products');
        const productTemplate = document.querySelector('[data-template="product"]');
        productContainer.innerHTML = '';

        state.products.forEach((product) => {
          const productEl = productTemplate.cloneNode(true);
          productEl.dataset.productId = product.id;
          productEl.querySelector('[data-value="name"]').textContent = product.name;
          productEl.querySelector('[data-value="description"]').textContent = product.description;
          productEl.querySelector('[data-value="image_url"]').src = product.image_url;
          const radio = productEl.querySelector('input[type="radio"]');
          radio.value = product.id;

          // Custom price handling
          if (typeof product.custom_price !== 'number') {
            product.custom_price = product.price;
          }
          const priceInput = productEl.querySelector('[data-role="price-input"]');
          if (priceInput) {
            priceInput.value = product.custom_price;
            priceInput.addEventListener('input', (e) => {
              const val = Number(e.target.value || 0);
              product.custom_price = isNaN(val) ? 0 : Math.max(0, val);
              const isSelected = product.quantity > 0;
              if (isSelected) updateSummary();
            });
          }

          productEl.addEventListener('click', () => {
            document.querySelectorAll('[data-role="product"]').forEach(el => {
              el.classList.remove('border-blue-500', 'shadow-lg');
              const dotWrap = el.querySelector('.w-6.h-6.bg-white');
              if (dotWrap) dotWrap.classList.remove('border-blue-500');
              const dot = el.querySelector('.w-3.h-3.bg-blue-500');
              if (dot) dot.classList.add('scale-0');
            });

            productEl.classList.add('border-blue-500', 'shadow-lg');
            const dotWrap = productEl.querySelector('.w-6.h-6.bg-white');
            if (dotWrap) dotWrap.classList.add('border-blue-500');
            const dot = productEl.querySelector('.w-3.h-3.bg-blue-500');
            if (dot) dot.classList.remove('scale-0');
            radio.checked = true;

            state.products.forEach(p => p.quantity = (p.id === product.id) ? 1 : 0);
            updateSummary();
          });

          productContainer.appendChild(productEl);
        });
      }

      function renderForms() {
        const formsContainer = document.getElementById('forms');
        const fieldTemplate = document.querySelector('[data-template="field"]');
        formsContainer.innerHTML = '';

        state.fields.forEach(field => {
          const fieldEl = fieldTemplate.cloneNode(true);
          const label = fieldEl.querySelector('[data-value="label"]');
          label.textContent = field.label;
          if (field.required) label.innerHTML += ' <span class="text-red-500">*</span>';

          const input = fieldEl.querySelector('input');
          input.id = field.id;
          input.name = field.id;
          input.type = field.type;
          input.required = field.required;
          input.placeholder = `Masukkan ${field.label.toLowerCase()}`;

          formsContainer.appendChild(fieldEl);
        });
      }

      function updateSummary() {
        const summaryItemsContainer = document.getElementById('summaryItems');
        const summaryItemTemplate = document.querySelector('[data-template="summary-item"]');
        summaryItemsContainer.innerHTML = '';
        let subtotal = 0;
        state.totalWeight = 0;

        const selectedProduct = state.products.find(p => p.quantity > 0);
        if (selectedProduct) {
          const itemEl = summaryItemTemplate.cloneNode(true);
          itemEl.classList.remove('hidden');
          itemEl.querySelector('[data-summary="name"]').textContent = selectedProduct.name;
          itemEl.querySelector('[data-summary="weight"]').textContent = 200;
          const lineTotal = typeof selectedProduct.custom_price === 'number' ? selectedProduct.custom_price : selectedProduct.price;
          itemEl.querySelector('[data-summary="line_total"]').textContent = formatCurrency(lineTotal);
          summaryItemsContainer.appendChild(itemEl);
          subtotal = lineTotal;
          state.totalWeight = 200;
        }

        const shippingCost = state.selectedCourier ? state.selectedCourier.cost[0].value : 0;
        state.shippingCost = shippingCost;
        state.totalPrice = subtotal + shippingCost;
        document.getElementById('shippingCost').textContent = formatCurrency(shippingCost);
        document.getElementById('totalPrice').textContent = formatCurrency(state.totalPrice);

        const shippingInfo = document.getElementById('shippingInfo');
        if (state.selectedCourier) {
          shippingInfo.classList.remove('hidden');
          document.getElementById('selectedCourier').textContent = `${state.selectedCourier.service} (${state.selectedCourier.description})`;
        } else {
          shippingInfo.classList.add('hidden');
        }
      }

      async function searchSubdistrict(query) {
        const dropdown = document.getElementById('dropdown');
        const loading = document.getElementById('loading');
        const resultsContainer = document.getElementById('results');
        if (query.length < 3) { dropdown.classList.add('hidden'); return; }
        dropdown.classList.remove('hidden');
        loading.classList.remove('hidden');
        resultsContainer.innerHTML = '';
        try {
          const response = await fetch(`${document.body.dataset.domain}/api/subdistricts?q=${query}`);
          const data = await response.json();
          loading.classList.add('hidden');
          if (data.length) {
            data.forEach(item => {
              const div = document.createElement('div');
              div.className = 'p-3 hover:bg-gray-100 cursor-pointer';
              div.textContent = `${item.subdistrict_name}, ${item.city}, ${item.province}`;
              div.addEventListener('click', () => {
                document.getElementById('subdistrict').value = div.textContent;
                dropdown.classList.add('hidden');
                state.selectedSubdistrict = item;
                fetchCourierOptions();
              });
              resultsContainer.appendChild(div);
            });
          } else {
            resultsContainer.textContent = 'Tidak ditemukan.';
          }
        } catch (error) {
          loading.classList.add('hidden');
          resultsContainer.textContent = 'Gagal memuat data.';
        }
      }

      async function fetchCourierOptions() {
        const courierGuard = document.getElementById('courierGuard');
        const courierLoading = document.getElementById('courierLoading');
        const courierList = document.getElementById('courierList');
        const courierItemTemplate = document.getElementById('courierItemTemplate');
        courierGuard.classList.add('hidden');
        courierLoading.classList.remove('hidden');
        courierList.innerHTML = '';
        try {
          const response = await fetch(`${document.body.dataset.domain}/api/ongkir`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ origin: document.body.dataset.originId, destination: state.selectedSubdistrict.subdistrict_id, weight: state.totalWeight, courier: state.couriers.join(':') })
          });
          const data = await response.json();
          courierLoading.classList.add('hidden');
          if (data.length) {
            const allCouriers = data.flatMap(group => group.costs.map(cost => ({...cost, code: group.code, name: group.name})));
            allCouriers.forEach(courier => {
              const courierEl = courierItemTemplate.cloneNode(true);
              courierEl.classList.remove('hidden');
              const radio = courierEl.querySelector('input[type="radio"]');
              radio.value = `${courier.code}-${courier.service}`;
              radio.addEventListener('change', () => { state.selectedCourier = courier; updateSummary(); });
              courierEl.querySelector('[data-field="name"]').textContent = `${courier.name} - ${courier.service}`;
              courierEl.querySelector('[data-field="price"]').textContent = `Rp ${formatCurrency(courier.cost[0].value)}`;
              courierEl.querySelector('[data-field="eta"]').textContent = courier.cost[0].etd;
              courierList.appendChild(courierEl);
            });
          } else {
            courierList.textContent = 'Tidak ada kurir tersedia.';
          }
        } catch (error) {
          courierLoading.classList.add('hidden');
          courierList.textContent = 'Gagal memuat data kurir.';
        }
      }

      document.getElementById('subdistrict').addEventListener('input', (e) => searchSubdistrict(e.target.value));

      document.getElementById('orderForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true; submitBtn.textContent = 'Memproses...';
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        const payload = {
          ...data,
          products: state.products.filter(p => p.quantity > 0),
          total: state.totalPrice,
          shipping_cost: state.shippingCost,
          courier: state.selectedCourier,
          subdistrict: state.selectedSubdistrict
        };
        try {
          const response = await fetch(`${document.body.dataset.domain}/api/orders`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
          if(response.ok) {
            document.getElementById('successMessage').classList.remove('hidden');
            document.getElementById('successContent').classList.add('scale-100', 'opacity-100');
          } else { alert('Gagal membuat pesanan. Silakan coba lagi.'); }
        } catch (error) { alert('Terjadi kesalahan. Silakan coba lagi.'); }
        finally { submitBtn.disabled = false; submitBtn.textContent = 'Selesaikan Pesanan'; }
      });

      // Initialize original logic
      initializeData();
      renderProducts();
      renderForms();
      updateSummary();

      // Stepper controls
      let currentStep = 1;
      const sections = Array.from(document.querySelectorAll('.step-section'));
      const dots = Array.from(document.querySelectorAll('.step-dot'));
      function updateStepperUI() {
        sections.forEach(sec => sec.classList.toggle('hidden', Number(sec.dataset.step) !== currentStep));
        dots.forEach(dot => {
          const idx = Number(dot.dataset.stepIndex);
          if (idx === currentStep) { dot.classList.remove('bg-gray-200','text-gray-700'); dot.classList.add('bg-blue-600','text-white'); }
          else { dot.classList.add('bg-gray-200','text-gray-700'); dot.classList.remove('bg-blue-600','text-white'); }
        });
        const progress = document.getElementById('stepProgress');
        progress.style.width = `${(currentStep/4)*100}%`;
      }
      document.querySelectorAll('[data-action="next"]').forEach(btn => btn.addEventListener('click', () => { currentStep = Math.min(4, currentStep + 1); updateStepperUI(); }));
      document.querySelectorAll('[data-action="prev"]').forEach(btn => btn.addEventListener('click', () => { currentStep = Math.max(1, currentStep - 1); updateStepperUI(); }));
      updateStepperUI();
    });
  </script>

  <!-- Stepper UI behavior (match single_product/form_ms.html) -->
  <script>
    (function() {
      const steps = Array.from(document.querySelectorAll('.step-section'));
      const stepperNodes = document.querySelectorAll('#ms-stepper .step-node');
      let currentStepIndex = steps.findIndex(sec => !sec.classList.contains('hidden'));
      if (currentStepIndex < 0) currentStepIndex = 0;

      function updateStepperUI() {
        stepperNodes.forEach((node) => {
          const idx = Number(node.dataset.stepIndex);
          const circle = node.querySelector('div');
          if (!circle) return;
          if (idx < currentStepIndex) {
            circle.classList.remove('bg-gray-100','text-gray-500');
            circle.classList.add('bg-green-100','text-green-600');
          } else if (idx === currentStepIndex) {
            circle.classList.remove('bg-gray-100','text-gray-500');
            circle.classList.add('bg-blue-100','text-blue-600');
          } else {
            circle.classList.remove('bg-blue-100','text-blue-600','bg-green-100','text-green-600');
            circle.classList.add('bg-gray-100','text-gray-500');
          }
        });
      }

      function showStep(index) {
        currentStepIndex = Math.max(0, Math.min(index, steps.length - 1));
        steps.forEach((sec, i) => sec.classList.toggle('hidden', i !== currentStepIndex));
        updateStepperUI();
      }

      document.querySelectorAll('[data-action="next"]').forEach(btn => btn.addEventListener('click', () => showStep(currentStepIndex + 1)));
      document.querySelectorAll('[data-action="prev"]').forEach(btn => btn.addEventListener('click', () => showStep(currentStepIndex - 1)));

      updateStepperUI();
    })();
  </script>
</body>

</html>
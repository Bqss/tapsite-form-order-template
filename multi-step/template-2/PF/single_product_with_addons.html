<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>tapsite.ai • Produk Fisik • Single Product + Add-ons • form2_ms</title>
  <script src="https://cdn.tailwindcss.com/3.4.16"></script>
</head>

<body
  data-products="[{'id':'BP01','name':'Base Cupcake Box (6 pcs)','price':120000,'description':'Paket dasar 6 cupcake pilihan.','image_url':'https://storage.tapsite.ai/media/assets/cupcake-box.webp','is_addon':false,'is_required':true,'weight':1000},{'id':'AD01','name':'Extra Topping: Choco Chips','price':5000,'description':'Taburan choco chips ekstra.','image_url':'','is_addon':true,'is_required':false,'weight':20},{'id':'AD02','name':'Extra Topping: Strawberry Slice','price':7000,'description':'Irisan stroberi segar.','image_url':'','is_addon':true,'is_required':false,'weight':30},{'id':'AD03','name':'Message Card','price':8000,'description':'Kartu ucapan personal.','image_url':'','is_addon':true,'is_required':false,'weight':10}]"
  data-fields="{'fields':[{'id':'name','label':'Nama','type':'text','required':true},{'id':'email','label':'Email','type':'email','required':false},{'id':'phone','label':'Nomor Telepon','type':'tel','required':true},{'id':'address','label':'Alamat Lengkap','type':'text','required':true}]}"
  data-couriers='["JNE","JNECargo","SiCepat","SiCepatCargo","SAP","SapCargo","iDexpress","JT","lion","iDexpressCargo","paxel","Ninja"]'
  data-domain="http://localhost:5556"
  data-origin-id="5fc63944f8f44b34aa4c819e"
  class="min-h-screen bg-gradient-to-br from-teal-50 via-emerald-50 to-cyan-50">

  <!-- Header + Stepper (samakan dengan form2_ms sebelumnya) -->
  <header class="px-4 py-10 sm:px-6 lg:px-8">
    <div class="max-w-6xl mx-auto">
      <div class="rounded-3xl bg-gradient-to-b from-teal-700 to-emerald-600 text-white p-6 sm:p-8 shadow-xl">
        <h1 class="text-3xl font-extrabold tracking-tight">Order Form • Produk + Add-ons • Multi-step</h1>
        <p class="mt-2 opacity-90">Pilih paket dasar dan add-ons, isi data pemesan, tentukan pengiriman, lalu konfirmasi ringkasan.</p>
        <div class="mt-6">
          <div class="w-full bg-white/20 rounded-full h-2">
            <div id="stepProgressBar" class="bg-white h-2 rounded-full transition-all duration-500" style="width:25%"></div>
          </div>
          <div class="mt-3 grid grid-cols-4 gap-2 text-xs sm:text-sm">
            <div data-step-index="1" class="flex items-center gap-2 px-3 py-2 rounded-lg bg-white text-teal-800 ring-2 ring-white/70 shadow-md scale-[1.02] font-semibold">
              <span class="flex h-6 w-6 items-center justify-center rounded-full bg-white text-teal-700 font-bold">1</span>
              Produk
            </div>
            <div data-step-index="2" class="flex items-center gap-2 px-3 py-2 rounded-lg bg-white/10 text-white/80 opacity-80">
              <span class="flex h-6 w-6 items-center justify-center rounded-full bg-white/70 text-teal-800 font-semibold">2</span>
              Pemesan
            </div>
            <div data-step-index="3" class="flex items-center gap-2 px-3 py-2 rounded-lg bg-white/10 text-white/80 opacity-80">
              <span class="flex h-6 w-6 items-center justify-center rounded-full bg-white/70 text-teal-800 font-semibold">3</span>
              Pengiriman
            </div>
            <div data-step-index="4" class="flex items-center gap-2 px-3 py-2 rounded-lg bg-white/10 text-white/80 opacity-80">
              <span class="flex h-6 w-6 items-center justify-center rounded-full bg-white/70 text-teal-800 font-semibold">4</span>
              Ringkasan
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <section class="px-4 pb-12 sm:px-6 lg:px-8">
    <div class="max-w-6xl mx-auto">
      <form id="orderForm" class="bg-white rounded-3xl shadow-xl ring-1 ring-teal-100 p-6 sm:p-8">

        <!-- Step 1: Pilih Produk + Add-ons -->
        <div id="step1" data-step="1" class="space-y-5">
          <h2 class="text-xl font-bold text-gray-900">Pilih Paket Dasar dan Add-ons</h2>
          <!-- Base Product -->
          <div id="baseProduct" class="space-y-3 mb-6">
            <div data-role="base" data-template="base" class="group bg-white/80 backdrop-blur-sm border border-teal-100 rounded-2xl p-3 shadow-sm hover:shadow-md hover:-translate-y-0.5 hover:ring-1 hover:ring-teal-300 transition-all duration-300">
              <div class="flex items-center gap-3">
                <img data-value="image_url" src="https://placehold.co/300x240/e2e8f0/0f766e?text=Produk" alt="Produk" class="w-20 h-20 rounded-xl object-cover border border-gray-200" />
                <div class="flex-1 min-w-0">
                  <div class="flex items-start justify-between gap-2">
                    <h3 class="text-lg font-bold text-gray-900" data-value="name">Nama Produk</h3>
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-teal-50 text-teal-700 border border-teal-100">Produk utama</span>
                  </div>
                  <p class="text-base text-gray-600" data-value="description">Deskripsi singkat produk.</p>
                  <div class="mt-2 flex items-center gap-3">
                    <p class="text-lg text-teal-600 font-semibold" data-value="price">Rp 0</p>
                    <span class="text-sm text-gray-500">Berat: <span data-value="weight">0</span>g</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Add-ons -->
          <h3 class="text-lg font-bold text-gray-900">Add-ons</h3>
          <p class="text-sm text-gray-600">Pilih add-ons opsional untuk melengkapi paketmu</p>
          <div id="addonsList" class="flex flex-col gap-3">
            <div id="addonItemTemplate" data-template="addon-item" class="hidden">
              <label class="group flex items-start gap-3 p-4 bg-white/80 backdrop-blur-sm border border-teal-100 rounded-2xl hover:shadow-md hover:-translate-y-0.5 hover:ring-1 hover:ring-teal-300 transition-all duration-300 cursor-pointer">
                <input type="checkbox" class="mt-1.5 w-4 h-4 text-teal-600 focus:ring-teal-500" />
                <div class="flex-1">
                  <div class="flex justify-between items-start gap-2">
                    <span class="text-base font-medium text-gray-900" data-field="name">Addon</span>
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-sm font-semibold bg-teal-50 text-teal-700 border border-teal-100" data-field="price">Rp 0</span>
                  </div>
                  <p class="text-sm text-gray-600 mt-1" data-field="description"></p>
                </div>
              </label>
            </div>
          </div>

          <div class="pt-4 flex items-center justify-end gap-3">
            <button type="button" id="btnNext1" class="px-5 py-2.5 bg-gradient-to-r from-teal-600 to-cyan-600 text-white font-semibold rounded-lg shadow hover:shadow-md transition-all">Lanjutkan</button>
          </div>
        </div>

        <!-- Step 2: Informasi Pemesan -->
        <div id="step2" data-step="2" class="space-y-5 hidden">
          <h2 class="text-xl font-bold text-gray-900">Informasi Pemesan</h2>
          <p class="text-sm text-gray-600">Lengkapi data pemesan. Field bertanda * wajib diisi.</p>
          <div id="forms" class="grid grid-cols-1 gap-4">
            <div data-role="field" data-template="field" class="space-y-2">
              <label class="block text-sm font-medium text-gray-700" data-value="label">Nama <span class="text-red-500">*</span></label>
              <input type="text" required class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all" placeholder="Masukkan nama lengkap" />
            </div>
          </div>
          <div class="pt-4 flex items-center justify-between gap-3">
            <button type="button" id="btnBack2" class="px-5 py-2.5 bg-white text-teal-700 border border-teal-200 rounded-lg hover:bg-teal-50 transition-all">Kembali</button>
            <button type="button" id="btnNext2" class="px-5 py-2.5 bg-gradient-to-r from-teal-600 to-cyan-600 text-white font-semibold rounded-lg shadow hover:shadow-md transition-all">Lanjutkan</button>
          </div>
        </div>

        <!-- Step 3: Informasi Pengiriman -->
        <div id="step3" data-step="3" class="space-y-5 hidden">
          <h2 class="text-xl font-bold text-gray-900">Informasi Pengiriman</h2>
          <div class="space-y-6">
            <div class="relative">
              <label for="subdistrict" class="block text-sm font-medium text-gray-700 mb-2">Desa/Kelurahan <span class="text-red-500">*</span></label>
              <input type="text" id="subdistrict" name="subdistrict" required class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all" placeholder="Ketik nama desa/kelurahan..." />
              <div id="dropdown" class="absolute z-10 w-full bg-white border border-gray-200 rounded-lg mt-2 shadow-lg hidden">
                <div id="loading" class="p-3 text-center text-gray-500 hidden">Mencari alamat...</div>
                <div id="results"></div>
              </div>
            </div>

            <div>
              <label for="address" class="block text-sm font-medium text-gray-700 mb-2">Alamat Lengkap <span class="text-red-500">*</span></label>
              <textarea id="address" name="address" required rows="3" class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all" placeholder="Nama jalan, nomor rumah, patokan, dsb."></textarea>
            </div>

            <div id="courierOptions" class="hidden">
              <h4 class="text-base font-semibold text-gray-900 mb-2">Pilih Kurir</h4>
              <div id="courierGuard" class="text-sm text-gray-500">Silakan pilih alamat dahulu untuk melihat opsi kurir.</div>
              <div id="courierList" class="space-y-2 mt-2">
                <div id="courierLoading" class="hidden p-2 text-sm text-gray-500">Menghitung ongkir...</div>
                <div id="courierItemTemplate" class="hidden">
                  <div class="flex items-center p-3 border-2 border-gray-200 rounded-lg hover:border-teal-300 transition-colors cursor-pointer">
                    <input type="radio" name="courier" class="mr-3 w-4 h-4 text-teal-600 focus:ring-teal-500" />
                    <label class="flex-1 cursor-pointer">
                      <div class="flex justify-between items-center">
                        <span class="font-medium" data-field="name">Kurir</span>
                        <span class="text-teal-700 font-semibold" data-field="price">Rp 0</span>
                      </div>
                      <div class="text-sm text-gray-500">Estimasi: <span data-field="eta">-</span></div>
                    </label>
                  </div>
                </div>
                <div id="courierError" class="hidden text-red-600 text-sm">Silakan pilih kurir terlebih dahulu</div>
              </div>
            </div>
          </div>
          <div class="pt-4 flex items-center justify-between gap-3">
            <button type="button" id="btnBack3" class="px-5 py-2.5 bg-white text-teal-700 border border-teal-200 rounded-lg hover:bg-teal-50 transition-all">Kembali</button>
            <button type="button" id="btnNext3" class="px-5 py-2.5 bg-gradient-to-r from-teal-600 to-cyan-600 text-white font-semibold rounded-lg shadow hover:shadow-md transition-all">Lanjutkan</button>
          </div>
        </div>

        <!-- Step 4: Ringkasan -->
        <div id="step4" data-step="4" class="space-y-5 hidden">
          <h2 class="text-xl font-bold text-gray-900">Ringkasan Pesanan</h2>
          <p class="text-sm text-gray-600">Detail paket dan add-ons terpilih:</p>
          <div class="bg-gradient-to-br from-white to-cyan-50 rounded-2xl p-4 border border-teal-100">
            <div id="summaryItems" class="space-y-3"></div>

            <div id="summaryItemTemplate" data-template="summary-item" data-role="summary-item" class="hidden">
              <div class="flex items-center justify-between pb-3 border-b border-teal-100">
                <div>
                  <h3 class="font-semibold text-gray-900" data-summary="name">Nama Item</h3>
                  <p class="text-xs text-gray-500">Berat: <span data-summary="weight">0</span>g</p>
                </div>
                <div class="text-right">
                  <p class="text-sm text-gray-600">Rp <span data-summary="unit_price">0</span> × <span data-summary="qty">1</span></p>
                  <p class="font-semibold text-gray-900">Rp <span data-summary="line_total">0</span></p>
                </div>
              </div>
            </div>

            <div id="shippingInfo" class="hidden mt-3 border border-teal-100 rounded-xl p-3 bg-white/60">
              <div class="text-sm text-gray-700">Alamat: <span id="shippingAddress">-</span></div>
              <div class="text-sm text-gray-700">Kurir: <span id="selectedCourier">-</span></div>
              <div class="text-sm font-semibold text-teal-700">Ongkir: Rp <span id="shippingCost">0</span></div>
            </div>

            <div class="flex items-center justify-between pt-2">
              <h3 class="text-lg font-bold text-gray-900">Total</h3>
              <p class="text-xl font-extrabold text-teal-700">Rp <span id="totalPrice">0</span></p>
            </div>
          </div>
          <div class="pt-4 flex items-center justify-between gap-3">
            <button type="button" id="btnBack4" class="px-5 py-2.5 bg-white text-teal-700 border border-teal-200 rounded-lg hover:bg-teal-50 transition-all">Kembali</button>
            <button type="submit" id="submitBtn" class="px-6 py-3 bg-gradient-to-r from-teal-600 to-cyan-600 text-white font-bold rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2">Selesaikan Pesanan</button>
          </div>
        </div>

      </form>
    </div>
  </section>

  <!-- Success Modal -->
  <div id="successMessage" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
    <div id="successContent" class="bg-white rounded-2xl p-8 max-w-md mx-4 transform transition-all duration-300 scale-95 opacity-0">
      <div class="text-center">
        <div class="w-16 h-16 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-emerald-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
        </div>
        <h3 class="text-xl font-bold text-gray-900 mb-2">Pesanan Berhasil!</h3>
        <p class="text-gray-600 mb-6">Terima kasih. Kamu akan diarahkan ke halaman pembayaran.</p>
        <div class="w-full bg-gray-200 rounded-full h-2">
          <div class="bg-teal-600 h-2 rounded-full" id="progressBar" style="width:0%"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Dataset & constants
    const domain = document.body.dataset.domain || '';
    const originId = document.body.dataset.originId || '';
    const allowedCouriers = (() => { try { return JSON.parse((document.body.dataset.couriers||'[]').replace(/'/g,'"')); } catch { return ["JNE","JNECargo","SiCepat","SiCepatCargo","SAP","SapCargo","iDexpress","JT","lion","iDexpressCargo","paxel","Ninja"]; } })();
    const defaultWeight = 200; // fallback
    const fmt = (n)=>Number(n||0).toLocaleString('id-ID');

    // Stepper UI
    const stepProgressBar = document.getElementById('stepProgressBar');
    const stepperItems = document.querySelectorAll('[data-step-index]');
    const steps = [
      document.getElementById('step1'),
      document.getElementById('step2'),
      document.getElementById('step3'),
      document.getElementById('step4')
    ];
    let currentStep = 1;
    function updateStepperUI(step){
      stepperItems.forEach(el => {
        const idx = Number(el.dataset.stepIndex);
        el.classList.remove('bg-white/20','text-white');
        el.classList.remove('bg-white/10','text-white/80','opacity-80');
        el.classList.remove('ring-2','ring-white/70','shadow-md','scale-[1.02]','font-semibold');
        if (idx === step){
          el.classList.add('bg-white','text-teal-800','ring-2','ring-white/70','shadow-md','scale-[1.02]','font-semibold');
        } else {
          el.classList.add('bg-white/10','text-white/80','opacity-80');
        }
      });
      stepProgressBar.style.width = (step * 25) + '%';
    }
    function goToStep(step){
      currentStep = Math.max(1, Math.min(4, step));
      steps.forEach((el, i) => {
        if (!el) return; const idx = i+1;
        if (idx === currentStep){ el.classList.remove('hidden'); el.classList.add('animate-[fadeIn_0.3s_ease]'); }
        else { el.classList.add('hidden'); el.classList.remove('animate-[fadeIn_0.3s_ease]'); }
      });
      updateStepperUI(currentStep);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    updateStepperUI(1);

    // Navigation buttons
    const btnNext1 = document.getElementById('btnNext1');
    const btnBack2 = document.getElementById('btnBack2');
    const btnNext2 = document.getElementById('btnNext2');
    const btnBack3 = document.getElementById('btnBack3');
    const btnNext3 = document.getElementById('btnNext3');
    const btnBack4 = document.getElementById('btnBack4');
    btnNext1?.addEventListener('click', () => { goToStep(2); });
    btnBack2?.addEventListener('click', () => goToStep(1));
    btnNext2?.addEventListener('click', () => {
      // Validasi field (kecuali address)
      let fields = []; try { const parsed = JSON.parse((document.body.dataset.fields||'{}').replace(/'/g,'"')); fields = Array.isArray(parsed.fields)?parsed.fields.filter(f=>f.id!=='address'):[]; } catch {}
      const formValues = {}; const missingRequired = [];
      fields.forEach(f=>{ const el = document.getElementById(f.id) || document.querySelector(`[name="${f.id}"]`); const val = el ? (el.value||'').trim() : ''; formValues[f.id] = val; if (f.required && !val) missingRequired.push(f.label||f.id); });
      if (missingRequired.length){ alert('Mohon lengkapi field wajib: ' + missingRequired.join(', ')); return; }
      Object.assign(window.customerData, formValues);
      goToStep(3);
    });
    btnBack3?.addEventListener('click', () => goToStep(2));
    btnNext3?.addEventListener('click', () => {
      if (!selectedAddress){ alert('Mohon pilih desa/kelurahan terlebih dahulu'); return; }
      const addrVal = document.getElementById('address')?.value?.trim() || '';
      if (!addrVal){ alert('Mohon isi Alamat Lengkap'); return; }
      if (!window.customerData.courier_name){ document.getElementById('courierError')?.classList.remove('hidden'); alert('Mohon pilih kurir pengiriman'); return; }
      window.customerData.address = addrVal;
      window.customerData.full_address = `${addrVal}, ${selectedAddress.subdistrict}, ${selectedAddress.district}, ${selectedAddress.city}, ${selectedAddress.province}`;
      goToStep(4);
    });
    btnBack4?.addEventListener('click', () => goToStep(3));

    // DOM refs
    const baseContainer = document.getElementById('baseProduct');
    const addonsContainer = document.getElementById('addonsList');
    const summaryItemsContainer = document.getElementById('summaryItems');
    const summaryItemTemplate = document.getElementById('summaryItemTemplate');
    const totalPriceElement = document.getElementById('totalPrice');
    const orderForm = document.getElementById('orderForm');
    const submitBtn = document.getElementById('submitBtn');
    const successMessage = document.getElementById('successMessage');
    const successContent = document.getElementById('successContent');
    const progressBar = document.getElementById('progressBar');
    const addressInput = document.getElementById('address');

    // Address & courier UI
    const subdistrictInput = document.getElementById('subdistrict');
    const dropdown = document.getElementById('dropdown');
    const resultsElement = document.getElementById('results');
    const loadingElement = document.getElementById('loading');
    const courierOptions = document.getElementById('courierOptions');
    const courierGuard = document.getElementById('courierGuard');
    const courierList = document.getElementById('courierList');
    const courierLoadingEl = document.getElementById('courierLoading');
    const courierItemTemplate = document.getElementById('courierItemTemplate');

    let debounceTimer = null; let selectedAddress = null;
    window.customerData = { subtotal: 0, weight: 0, quantity: 1 };
    window.productsData = [];

    // Render Produk (Base + Add-ons)
    (function initProducts(){
      try {
        const raw = document.body.dataset.products || '[]';
        const products = JSON.parse(raw.replace(/'/g,'"'));
        window.productsData = products.map(p=> ({...p, quantity: (p.is_addon ? 0 : 1)}));
        // Base
        const base = products.find(p=>!p.is_addon);
        if (base && baseContainer){
          const template = baseContainer.querySelector('[data-role="base"]');
          const el = template.cloneNode(true);
          const imgEl = el.querySelector('[data-value="image_url"]') || el.querySelector('img');
          if (imgEl && base.image_url) imgEl.src = base.image_url;
          el.querySelector('[data-value="name"]').textContent = base.name || '';
          el.querySelector('[data-value="description"]').textContent = base.description || '';
          el.querySelector('[data-value="price"]').textContent = 'Rp ' + Number(base.price||0).toLocaleString('id-ID');
          el.querySelector('[data-value="weight"]').textContent = Number(base.weight||defaultWeight);
          baseContainer.innerHTML = el.outerHTML;
        }
        // Addons
        const addonTpl = document.getElementById('addonItemTemplate');
        if (addonsContainer && addonTpl){
          addonsContainer.innerHTML = '';
          products.filter(p=>p.is_addon).forEach(p=>{
            const el = addonTpl.cloneNode(true); el.classList.remove('hidden'); el.removeAttribute('id');
            el.setAttribute('data-product-id', p.id);
            const nameEl = el.querySelector('[data-field="name"]'); const priceEl = el.querySelector('[data-field="price"]'); const descEl = el.querySelector('[data-field="description"]');
            if (nameEl) nameEl.textContent = p.name || '';
            if (priceEl) priceEl.textContent = 'Rp ' + Number(p.price||0).toLocaleString('id-ID');
            if (descEl) descEl.textContent = p.description || '';
            const cb = el.querySelector('input[type="checkbox"]');
            const idx = window.productsData.findIndex(x=>x.id===p.id);
            if (cb){ cb.checked = (window.productsData[idx]?.quantity||0)>0; cb.addEventListener('change', ()=>{ window.productsData[idx].quantity = cb.checked ? 1 : 0; updateSummary(); }); }
            addonsContainer.appendChild(el);
          });
        }
        updateSummary();
      } catch(err){ console.warn('initProducts fail', err); }
    })();

    // Field Dinamis
    (function initFields(){
      try {
        const raw = document.body.dataset.fields || '{}';
        const parsed = JSON.parse(raw.replace(/'/g,'"'));
        const fields = Array.isArray(parsed.fields) ? parsed.fields : [];
        const container = document.getElementById('forms');
        const template = container ? container.querySelector('[data-role="field"]') : null;
        if (!container || !template || !fields.length) return;
        container.innerHTML = '';
        fields.filter(f=>f.id!== 'address').forEach(field => {
          const el = template.cloneNode(true);
          const labelEl = el.querySelector('[data-value="label"]') || el.querySelector('label');
          const inputEl = el.querySelector('input');
          if (labelEl) { const labelText = field.label || ''; labelEl.innerHTML = `${labelText}${field.required ? ' <span class=\"text-red-500\">*</span>' : ''}`; if (field.id) labelEl.setAttribute('for', field.id); }
          if (inputEl) { if (field.type) inputEl.setAttribute('type', field.type); if (field.id) { inputEl.setAttribute('id', field.id); inputEl.setAttribute('name', field.id); } inputEl.required = !!field.required; let placeholder = inputEl.getAttribute('placeholder') || ''; if (field.type === 'email') placeholder = 'email@example.com'; else if (field.type === 'tel') placeholder = '08xxxxxxxxxx'; else if (field.type === 'text') placeholder = `Masukkan ${String(field.label || '').toLowerCase()}`.trim(); inputEl.setAttribute('placeholder', placeholder); }
          container.appendChild(el);
        });
      } catch(e){ console.warn('Gagal render fields:', e); }
    })();

    // Sync alamat lengkap ke ringkasan pengiriman
    addressInput?.addEventListener('input', (e) => {
      const val = (e.target.value||'').trim();
      window.customerData.address = val;
      const shippingAddressEl = document.getElementById('shippingAddress');
      if (shippingAddressEl) shippingAddressEl.textContent = val || '-';
    });

    // Summary updater
    function updateSummary(){
      const base = window.productsData.find(p=>!p.is_addon);
      const addons = window.productsData.filter(p=>p.is_addon && (p.quantity||0)>0);
      const fragment = document.createDocumentFragment();
      let subtotal = 0; let totalWeight = 0;
      if (base){
        const qty = 1; const price = Number(base.price||0); const weight = Number(base.weight||defaultWeight);
        subtotal += price * qty; totalWeight += weight * qty;
        const el = summaryItemTemplate.cloneNode(true); el.classList.remove('hidden');
        el.querySelector('[data-summary="name"]').textContent = base.name || '';
        el.querySelector('[data-summary="weight"]').textContent = weight * qty;
        el.querySelector('[data-summary="unit_price"]').textContent = fmt(price);
        el.querySelector('[data-summary="qty"]').textContent = qty;
        el.querySelector('[data-summary="line_total"]').textContent = fmt(price*qty);
        fragment.appendChild(el);
      }
      addons.forEach(p=>{
        const qty = Number(p.quantity||0); const price = Number(p.price||0); const weight = Number(p.weight||defaultWeight);
        subtotal += price * qty; totalWeight += weight * qty;
        const el = summaryItemTemplate.cloneNode(true); el.classList.remove('hidden');
        el.querySelector('[data-summary="name"]').textContent = p.name || '';
        el.querySelector('[data-summary="weight"]').textContent = weight * qty;
        el.querySelector('[data-summary="unit_price"]').textContent = fmt(price);
        el.querySelector('[data-summary="qty"]').textContent = qty;
        el.querySelector('[data-summary="line_total"]').textContent = fmt(price*qty);
        fragment.appendChild(el);
      });
      summaryItemsContainer.innerHTML = ''; summaryItemsContainer.appendChild(fragment);
      const shippingCostEl = document.getElementById('shippingCost');
      const shippingCost = parseInt((shippingCostEl?.textContent||'').replace(/\./g,''))||0;
      totalPriceElement.textContent = fmt(subtotal + shippingCost);
      window.customerData.subtotal = subtotal; window.customerData.weight = totalWeight;
      if (selectedAddress && totalWeight>0) calculateShippingCost();
    }

    // Address search
    subdistrictInput?.addEventListener('input', function(){
      clearTimeout(debounceTimer);
      const q = this.value.trim();
      if (q.length < 2){ dropdown?.classList.add('hidden'); return; }
      debounceTimer = setTimeout(()=> searchAddress(q), 500);
    });
    async function searchAddress(query){
      loadingElement?.classList.remove('hidden'); resultsElement.innerHTML=''; dropdown?.classList.remove('hidden');
      try{
        const resp = await fetch(`${domain}/api/address/search?keyword=${encodeURIComponent(query)}`);
        const data = await resp.json();
        if (data.success && data.data.length>0){ displayResults(data.data); } else { resultsElement.innerHTML = '<div class=\"p-3 text-center text-gray-500\">Tidak ada hasil</div>'; }
      } catch(err){ console.error('searchAddress', err); resultsElement.innerHTML = '<div class=\"p-3 text-center text-red-500\">Terjadi kesalahan</div>'; }
      finally { loadingElement?.classList.add('hidden'); }
    }
    function displayResults(addresses){
      resultsElement.innerHTML = addresses.map(addr => `<div onclick=\"selectAddress('${addr._id}','${addr.SUBDISTRICT_NAME}','${addr.DISTRICT_NAME}','${addr.CITY_NAME}','${addr.PROVINCE_NAME}','${addr.ZIP_CODE||''}')\" class=\"p-3 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-0\">${addr.SUBDISTRICT_NAME}, ${addr.DISTRICT_NAME}, ${addr.CITY_NAME}</div>`).join('');
    }
    window.selectAddress = function(id, subdistrict, district, city, province, zipCode){
      selectedAddress = { id, subdistrict, district, city, province, zipCode };
      if (subdistrictInput) subdistrictInput.value = `${subdistrict}, ${district}, ${city}`;
      dropdown?.classList.add('hidden');
      Object.assign(window.customerData, { subdistrict, district, city, province, zip_code: zipCode, destination_id: id });
      courierGuard && courierGuard.classList.add('hidden');
      courierOptions && courierOptions.classList.remove('hidden');
      courierLoadingEl && courierLoadingEl.classList.remove('hidden');
      calculateShippingCost();
    };

    async function calculateShippingCost(){
      const totalWeight = Number(window.customerData.weight||0) || 0;
      if (!selectedAddress || totalWeight<=0){
        const shippingInfo = document.getElementById('shippingInfo');
        courierOptions && courierOptions.classList.remove('hidden');
        courierGuard && courierGuard.classList.remove('hidden');
        courierLoadingEl && courierLoadingEl.classList.add('hidden');
        shippingInfo && shippingInfo.classList.add('hidden');
        return;
      }
      try{
        courierGuard && courierGuard.classList.add('hidden');
        courierOptions && courierOptions.classList.remove('hidden');
        courierLoadingEl && courierLoadingEl.classList.remove('hidden');
        const response = await fetch(`${domain}/api/address/shipping-estimate?origin_id=${originId}&destination_id=${selectedAddress.id}&weight=${totalWeight}`);
        const data = await response.json();
        if (data.success){ displayCourierOptions(data.data); }
      } catch(err){ console.error('calculateShippingCost', err); }
      finally { courierLoadingEl && courierLoadingEl.classList.add('hidden'); }
    }

    function displayCourierOptions(shippingData){
      const preSelected = (window.customerData && window.customerData.courier_name) || null;
      courierLoadingEl && courierLoadingEl.classList.add('hidden');
      // Reset list except template & loading
      Array.from(courierList.children).forEach(ch=>{ if (ch.id!=='courierItemTemplate' && ch.id!=='courierLoading' && ch.id!=='courierError') ch.remove(); });
      let hasValid = false;
      Object.entries(shippingData).forEach(([courier, details])=>{
        if (!allowedCouriers.includes(courier)) return;
        if (!(details.price>0)) return;
        hasValid = true;
        let el; const inputId = `courier-${courier}`;
        if (courierItemTemplate){
          el = courierItemTemplate.cloneNode(true); el.id=''; el.classList.remove('hidden');
          const inputEl = el.querySelector('input[type="radio"]'); const labelEl = el.querySelector('label');
          const nameEl = el.querySelector('[data-field="name"]'); const priceEl = el.querySelector('[data-field="price"]'); const etaEl = el.querySelector('[data-field="eta"]');
          if (inputEl){ inputEl.id=inputId; inputEl.name='courier'; inputEl.value=courier; if (preSelected===courier) inputEl.checked=true; }
          if (labelEl) labelEl.setAttribute('for', inputId);
          if (nameEl) nameEl.textContent = courier;
          if (priceEl) priceEl.textContent = `Rp ${Number(details.price||0).toLocaleString('id-ID')}`;
          if (etaEl) etaEl.textContent = details.estimatedDate || '-';
          el.addEventListener('click', function(){ if (inputEl) inputEl.checked=true; selectCourier(courier, Number(details.price||0)); });
        } else {
          const courierDiv = document.createElement('div');
          courierDiv.className = 'flex items-center p-3 border-2 border-gray-200 rounded-lg hover:border-teal-300 transition-colors cursor-pointer';
          courierDiv.innerHTML = `<input type=\"radio\" id=\"${inputId}\" name=\"courier\" value=\"${courier}\" class=\"mr-3 w-4 h-4 text-teal-600 focus:ring-teal-500\"><label for=\"${inputId}\" class=\"flex-1 cursor-pointer\"><div class=\"flex justify-between items-center\"><span class=\"font-medium\">${courier}</span><span class=\"text-teal-700 font-semibold\">Rp ${Number(details.price||0).toLocaleString('id-ID')}</span></div><div class=\"text-sm text-gray-500\">Estimasi: ${details.estimatedDate||'-'}</div></label>`;
          courierDiv.addEventListener('click', function(){ document.getElementById(inputId).checked = true; selectCourier(courier, Number(details.price||0)); });
          if (preSelected===courier){ const radio = courierDiv.querySelector('input[type="radio"]'); if (radio) radio.checked=true; }
          el = courierDiv;
        }
        courierList.appendChild(el);
      });
      if (hasValid){
        courierOptions.classList.remove('hidden');
        if (preSelected && shippingData[preSelected] && shippingData[preSelected].price>0){ selectCourier(preSelected, Number(shippingData[preSelected].price||0)); }
      }
    }

    function selectCourier(courier, price){
      window.customerData.courier_name = courier; window.customerData.shipping_cost = Number(price||0);
      const shippingInfo = document.getElementById('shippingInfo');
      const shippingAddress = document.getElementById('shippingAddress');
      const selectedCourierEl = document.getElementById('selectedCourier');
      const shippingCostEl = document.getElementById('shippingCost');
      shippingInfo && shippingInfo.classList.remove('hidden');
      shippingAddress && (shippingAddress.textContent = (window.customerData.full_address || window.customerData.address || 'Alamat lengkap'));
      selectedCourierEl && (selectedCourierEl.textContent = courier);
      shippingCostEl && (shippingCostEl.textContent = Number(price||0).toLocaleString('id-ID'));
      updateSummary();
      const courierErrorEl = document.getElementById('courierError'); if (courierErrorEl) courierErrorEl.classList.add('hidden');
    }

    // Submit
    orderForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const base = window.productsData.find(p=>!p.is_addon);
      if (!base){ alert('Produk dasar tidak ditemukan'); goToStep(1); return; }

      // Validasi field pemesan
      let fields = []; try { const parsed = JSON.parse((document.body.dataset.fields||'{}').replace(/'/g,'"')); fields = Array.isArray(parsed.fields)?parsed.fields:[]; } catch {}
      const formValues = {}; const missingRequired = [];
      fields.forEach(f=>{ const el = document.getElementById(f.id) || orderForm.querySelector(`[name="${f.id}"]`); const val = el ? (el.value||'').trim() : ''; formValues[f.id] = val; if (f.required && !val) missingRequired.push(f.label||f.id); });
      if (missingRequired.length){ alert('Mohon lengkapi field wajib: ' + missingRequired.join(', ')); goToStep(2); return; }
      if (!selectedAddress){ alert('Mohon pilih desa/kelurahan'); goToStep(3); return; }
      if (!window.customerData.courier_name){ document.getElementById('courierError')?.classList.remove('hidden'); alert('Mohon pilih kurir'); goToStep(3); return; }

      Object.assign(window.customerData, formValues);
      const addrVal = formValues.address || addressInput?.value?.trim() || '';
      if (!addrVal){ alert('Mohon isi Alamat Lengkap'); goToStep(3); return; }
      window.customerData.address = addrVal;
      window.customerData.full_address = `${addrVal}, ${selectedAddress.subdistrict}, ${selectedAddress.district}, ${selectedAddress.city}, ${selectedAddress.province}`;

      // Payload: base + addons terpilih
      const addons = window.productsData.filter(p=>p.is_addon && (p.quantity||0)>0);
      const subtotal = Number(window.customerData.subtotal||Number(base.price||0) + addons.reduce((a,b)=>a+Number(b.price||0)*(b.quantity||0),0));
      const shipping = Number(window.customerData.shipping_cost||0);
      const total = subtotal + shipping;
      const items = [
        { id: base.id, code: base.id, name: base.name, price: Number(base.price||0), quantity: 1, is_addon: !!base.is_addon }
      ].concat(addons.map(p=>({ id:p.id, code:p.id, name:p.name, price:Number(p.price||0), quantity:Number(p.quantity||0), is_addon:true })));

      const urlParams = new URLSearchParams(window.location.search);
      const utm = { utm_source: urlParams.get('utm_source')||'', utm_medium: urlParams.get('utm_medium')||'', utm_campaign: urlParams.get('utm_campaign')||'', utm_content: urlParams.get('utm_content')||'' };
      const submissionData = { customer_data: { ...window.customerData, utm_meta: utm }, subtotal, total, product: items };

      submitBtn.disabled = true; submitBtn.textContent = 'Memproses...'; submitBtn.classList.add('opacity-75','cursor-not-allowed');
      try{
        const response = await fetch(`${domain}/form/${originId}`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(submissionData) });
        const result = await response.json();
        if (result.id){
          successMessage.classList.remove('hidden');
          setTimeout(()=>{
            successContent.classList.remove('scale-95','opacity-0');
            successContent.classList.add('scale-100','opacity-100');
            let width=0; const interval=setInterval(()=>{
              width+=10; progressBar.style.width=width+'%';
              if (width>=100){ clearInterval(interval); window.location.href = `${domain}/invoice/${result.id}`; }
            },100);
          },100);
        } else {
          throw new Error('Failed to submit order');
        }
      } catch(err){ console.error('Error submitting order:', err); alert('Terjadi kesalahan saat mengirim pesanan. Silakan coba lagi.'); submitBtn.disabled=false; submitBtn.textContent='Selesaikan Pesanan'; submitBtn.classList.remove('opacity-75','cursor-not-allowed'); }
    });
  </script>
</body>
</html>
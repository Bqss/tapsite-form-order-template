<section class="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 py-8 px-4 sm:px-6 lg:px-8">
  <div class="w-full max-w-sm sm:max-w-md md:max-w-2xl lg:max-w-3xl mx-auto">
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold text-gray-900 mb-2">Form order A</h1>
      <p class="text-gray-600">Beli produk anda disini</p>
    </div>

    <!-- Form Container -->
    <div class="bg-white rounded-2xl shadow-xl overflow-hidden">

      <form id="orderForm" class="p-6 sm:p-8 lg:p-10">
        <!-- Stepper UI (aligned to single_product/form_ms.html) -->
        <div id="ms-stepper" class="flex items-center justify-between mb-6">
          <div class="flex-1 flex items-center">
            <div class="step-node" data-step-index="0">
              <div
                class="w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm bg-blue-100 text-blue-600">
                1</div>
              <div class="text-xs mt-1 text-gray-700">Produk</div>
            </div>
            <div class="flex-1 h-0.5 mx-2 bg-gray-200"></div>
            <div class="step-node" data-step-index="1">
              <div
                class="w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm bg-gray-100 text-gray-500">
                2</div>
              <div class="text-xs mt-1 text-gray-700">Identitas</div>
            </div>
            <div class="flex-1 h-0.5 mx-2 bg-gray-200"></div>
            <div class="step-node" data-step-index="2">
              <div
                class="w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm bg-gray-100 text-gray-500">
                3</div>
              <div class="text-xs mt-1 text-gray-700">Pengiriman</div>
            </div>
            <div class="flex-1 h-0.5 mx-2 bg-gray-200"></div>
            <div class="step-node" data-step-index="3">
              <div
                class="w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm bg-gray-100 text-gray-500">
                4</div>
              <div class="text-xs mt-1 text-gray-700">Ringkasan</div>
            </div>
          </div>
        </div>

        <!-- Step 1: Product Selection -->
        <section class="step-section" data-step="1">
          <div data-role="parent" class="mb-8 sm:mb-10">
            <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
              <span
                class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold text-sm mr-2">1</span>
              Pilih Produk
            </h2>
            <div class="flex flex-col gap-4" id="products">
              <div
                class="bg-white rounded-xl p-4 border-2 border-transparent transition-all duration-300 cursor-pointer shadow-md hover:shadow-lg hover:border-blue-500"
                data-role="product" data-template="product">
                <div class="flex flex-row gap-4 items-center">
                  <div class="flex-shrink-0">
                    <img data-value="image_url" src="https://placehold.co/300x300/e2e8f0/64748b?text=Produk"
                      alt="Produk" class="w-24 h-24 object-cover rounded-lg shadow-md border border-gray-200">
                  </div>
                  <div class="w-full min-w-0">
                    <div class="flex justify-between items-start mb-1">
                      <h3 class="text-lg font-bold text-gray-900" data-value="name">Nama Produk</h3>
                      <div
                        class="w-6 h-6 bg-white rounded-full border-2 border-gray-300 flex items-center justify-center transition-all duration-300 flex-shrink-0 ml-4">
                        <div class="w-3 h-3 bg-blue-500 rounded-full transform scale-0 transition-all duration-300">
                        </div>
                      </div>
                    </div>
                    <p class="text-sm text-gray-500 mt-1 truncate" data-value="description">Deskripsi</p>
                    <div class="flex items-center justify-between mt-3">
                      <div class="text-lg font-bold text-blue-600 flex items-center gap-2">
                        <span>Rp</span>
                        <input type="number" data-role="price-input" min="0" step="100"
                          class="w-28 px-2 py-1 border border-blue-200 rounded bg-blue-50 text-blue-700 font-semibold focus:outline-none focus:ring-2 focus:ring-blue-500"
                          placeholder="0" />
                      </div>
                      <span class="text-sm text-gray-500">200g</span>
                    </div>
                  </div>
                  <input type="radio" name="product_selection" class="hidden">
                </div>
              </div>
            </div>
          </div>
          <div class="flex justify-end gap-3">
            <button type="button" class="px-4 py-2 rounded-lg bg-blue-600 text-white" data-action="next">Lanjut</button>
          </div>
        </section>

        <!-- Step 2: Identity -->
        <section class="step-section hidden" data-step="2">
          <div data-role="parent" class="mb-8 sm:mb-10">
            <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
              <span
                class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold text-sm mr-2">2</span>
              Informasi Identitas
            </h2>
            <div class="space-y-6" id="forms">
              <div data-role="field" data-template="field">
                <label for="name" class="block text-base sm:text-sm font-medium text-gray-700 mb-2"
                  data-value="label">Nama <span class="text-red-500">*</span></label>
                <input type="text" id="name" name="name" required
                  class="w-full px-4 py-4 sm:py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-base"
                  placeholder="Masukkan nama lengkap Anda">
              </div>
            </div>
          </div>
          <div class="flex justify-between gap-3">
            <button type="button" class="px-4 py-2 rounded-lg bg-gray-200" data-action="prev">Kembali</button>
            <button type="button" class="px-4 py-2 rounded-lg bg-blue-600 text-white" data-action="next">Lanjut</button>
          </div>
        </section>

        <!-- Step 3: Shipping -->
        <section class="step-section hidden" data-step="3">
          <div data-role="parent" class="mb-8 sm:mb-10">
            <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
              <span
                class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold text-sm mr-2">3</span>
              Informasi Pengiriman
            </h2>
            <div class="space-y-6">
              <div class="relative">
                <label for="subdistrict"
                  class="block text-base sm:text-sm font-medium text-gray-700 mb-2">Desa/Kelurahan <span
                    class="text-red-500">*</span></label>
                <input type="text" id="subdistrict" name="subdistrict" required
                  class="w-full px-4 py-4 sm:py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-base"
                  placeholder="Ketik nama desa/kelurahan...">
                <div id="dropdown"
                  class="absolute bottom-full left-0 right-0 bg-white border-2 border-gray-200 rounded-lg shadow-lg z-50 max-h-60 overflow-y-auto hidden w-full mb-2">
                  <div id="loading" class="p-3 text-center hidden" data-placeholder="true">Mencari...</div>
                  <div id="results"></div>
                </div>
                <div class="mt-5">
                  <label for="address" class="block text-base sm:text-sm font-medium text-gray-700 mb-2">Alamat Lengkap
                    <span class="text-red-500">*</span></label>
                  <textarea id="address" name="address" rows="3" required
                    class="w-full px-4 py-4 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-base"
                    placeholder="Nama jalan, nomor rumah, RT/RW, patokan"></textarea>
                </div>
              </div>

              <div id="courierOptions">
                <label class="block text-base sm:text-sm font-medium text-gray-700 mb-2">Pilih Kurir <span
                    class="text-red-500">*</span></label>
                <div id="courierGuard"
                  class="mb-3 p-3 border-2 border-dashed border-gray-300 rounded-lg text-center text-sm text-gray-600"
                  data-placeholder="true">Pilih alamat terlebih dahulu untuk melihat pilihan kurir dan menghitung
                  ongkir.</div>
                <div id="courierList" class="space-y-3 grid grid-cols-2 gap-2">
                  <div id="courierLoading"
                    class="col-span-2 p-3 border-2 border-gray-200 rounded-lg text-gray-600 text-sm flex items-center gap-2 hidden"
                    data-placeholder="true">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 animate-spin text-gray-500"
                      viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M10 3a7 7 0 100 14v-2a5 5 0 110-10V3z" clip-rule="evenodd"></path>
                    </svg>
                    <span>Sedang menghitung ongkir dan mengambil daftar kurir...</span>
                  </div>
                  <div id="courierItemTemplate" data-role="courier-item" data-template="courier-item"
                    data-placeholder="true"
                    class="flex items-center p-3 border-2 border-gray-200 rounded-lg hover:border-blue-300 transition-colors cursor-pointer hidden">
                    <input type="radio" name="courier" class="mr-3 w-4 h-4 text-blue-600 focus:ring-blue-500" />
                    <label class="flex-1 cursor-pointer">
                      <div class="flex justify-between items-center">
                        <span class="font-medium" data-field="name">Nama Kurir</span>
                        <span class="text-blue-600 font-semibold" data-field="price">Rp 0</span>
                      </div>
                      <div class="text-sm text-gray-500">Estimasi: <span data-field="eta">2-3 Hari</span></div>
                    </label>
                  </div>
                </div>
                <div id="courierError" class="mt-2 text-red-500 text-sm hidden">Silakan pilih kurir pengiriman</div>
              </div>
            </div>
          </div>
          <div class="flex justify-between gap-3">
            <button type="button" class="px-4 py-2 rounded-lg bg-gray-200" data-action="prev">Kembali</button>
            <button type="button" class="px-4 py-2 rounded-lg bg-blue-600 text-white" data-action="next">Lanjut</button>
          </div>
        </section>

        <!-- Step 4: Summary -->
        <section class="step-section hidden" data-step="4">
          <div data-role="parent" class="mb-8 sm:mb-10">
            <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
              <span
                class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold text-sm mr-2">4</span>
              Ringkasan Pesanan
            </h2>
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 border border-blue-100">
              <div class="space-y-4">
                <div id="summaryItems" class="space-y-3"></div>
                <div id="summaryItemTemplate" data-template="summary-item" data-role="summary-item"
                  class="flex justify-between items-center pb-3 border-b border-blue-100 hidden">
                  <div>
                    <h3 class="font-semibold text-gray-900" data-summary="name">Test</h3>
                    <p class="text-sm text-gray-500">Berat: <span data-summary="weight">1000</span>g</p>
                  </div>
                  <div class="text-right">
                    <p class="font-semibold text-gray-900">Rp <span data-summary="line_total">0</span></p>
                  </div>
                </div>

                <div id="shippingInfo" class="hidden">
                  <div class="pb-3 border-b border-blue-100">
                    <h4 class="font-medium text-gray-900 mb-2">Informasi Pengiriman</h4>
                    <p class="text-sm text-gray-600" id="shippingAddress"></p>
                    <p class="text-sm text-gray-600 mt-1">Kurir: <span id="selectedCourier">jne</span></p>
                    <p class="text-sm text-gray-600">Ongkos Kirim: Rp <span id="shippingCost">0</span></p>
                  </div>
                </div>

                <div class="flex justify-between items-center ">
                  <h3 class="text-lg font-bold text-gray-900">Total</h3>
                  <p class="text-xl font-bold text-blue-600">Rp <span id="totalPrice">20.000</span></p>
                </div>
              </div>
            </div>
          </div>
          <div class="flex justify-between gap-3">
            <button type="button" class="px-4 py-2 rounded-lg bg-gray-200" data-action="prev">Kembali</button>
            <button type="submit" id="submitBtn"
              class="px-8 py-4 bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-bold rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300">Selesaikan
              Pesanan</button>
          </div>
        </section>
      </form>
    </div>

    <!-- Success Message -->
    <div id="successMessage" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-xl p-8 max-w-md mx-4 transform transition-all duration-300 scale-95 opacity-0"
        id="successContent">
        <div class="text-center">
          <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-500" viewBox="0 0 20 20"
              fill="currentColor">
              <path fill-rule="evenodd"
                d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                clip-rule="evenodd"></path>
            </svg>
          </div>
          <h2 class="text-2xl font-bold text-gray-900 mb-2">Pesanan Berhasil!</h2>
          <p class="text-gray-600 mb-6">Terima kasih telah melakukan pemesanan. Anda akan diarahkan ke halaman
            pembayaran.</p>
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div class="bg-blue-600 h-2 rounded-full" id="progressBar" style="width: 0%"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Scripts: correct interaction logic with custom price support -->
  <script>
    // Stepper UI behavior
    (function () {
      const steps = Array.from(document.querySelectorAll('.step-section'));
      const stepperNodes = document.querySelectorAll('#ms-stepper .step-node');
      let currentStepIndex = steps.findIndex(sec => !sec.classList.contains('hidden'));
      if (currentStepIndex < 0) currentStepIndex = 0;

      function updateStepperUI() {
        stepperNodes.forEach((node) => {
          const idx = Number(node.dataset.stepIndex);
          const circle = node.querySelector('div');
          if (!circle) return;
          if (idx < currentStepIndex) {
            circle.classList.remove('bg-gray-100', 'text-gray-500');
            circle.classList.add('bg-green-100', 'text-green-600');
          } else if (idx === currentStepIndex) {
            circle.classList.remove('bg-gray-100', 'text-gray-500');
            circle.classList.add('bg-blue-100', 'text-blue-600');
          } else {
            circle.classList.remove('bg-blue-100', 'text-blue-600', 'bg-green-100', 'text-green-600');
            circle.classList.add('bg-gray-100', 'text-gray-500');
          }
        });
      }

      function showStep(index) {
        currentStepIndex = Math.max(0, Math.min(index, steps.length - 1));
        steps.forEach((sec, i) => sec.classList.toggle('hidden', i !== currentStepIndex));
        updateStepperUI();
      }

      document.querySelectorAll('[data-action="next"]').forEach(btn => btn.addEventListener('click', () => showStep(currentStepIndex + 1)));
      document.querySelectorAll('[data-action="prev"]').forEach(btn => btn.addEventListener('click', () => showStep(currentStepIndex - 1)));

      updateStepperUI();
    })();

    const domain = document.body.dataset.domain || '';
    const originId = document.body.dataset.originId || '';
    const formId = document.body.dataset.formId || '';
    const submitEvent = document.body.dataset.submitEvent || '';
    const defaultWeight = 200;

    const productsContainer = document.getElementById('products');
    const summaryItemsContainer = document.getElementById('summaryItems');
    const summaryItemTemplate = document.getElementById('summaryItemTemplate');
    const totalPriceElement = document.getElementById('totalPrice');
    const subdistrictInput = document.getElementById('subdistrict');
    const dropdown = document.getElementById('dropdown');
    const loadingElement = document.getElementById('loading');
    const resultsElement = document.getElementById('results');
    const courierOptions = document.getElementById('courierOptions');
    const courierList = document.getElementById('courierList');
    const courierGuard = document.getElementById('courierGuard');
    const courierLoadingEl = document.getElementById('courierLoading');
    const orderForm = document.getElementById('orderForm');
    const submitBtn = document.getElementById('submitBtn');
    const successMessage = document.getElementById('successMessage');
    const successContent = document.getElementById('successContent');
    const progressBar = document.getElementById('progressBar');
    let debounceTimer; let selectedAddress = null;

    (function initProductRendering() {
      try {
        const raw = document.body.dataset.products || '[]';
        const products = JSON.parse(raw);

        // Initialize window.productsData first with quantity property
        window.productsData = products.map(p => {
          // Initialize custom_price if not set
          if (typeof p.custom_price !== 'number') {
            p.custom_price = p.price;
          }
          p.quantity = 0;
          return p;
        });
        window.selectedProductIndex = -1;

        const container = productsContainer;
        const template = container ? container.querySelector('[data-role="product"]') : null;
        if (!container || !template || !Array.isArray(products)) return;
        container.innerHTML = '';

        window.productsData.forEach((product, index) => {
          const el = template.cloneNode(true);
          const imgEl = el.querySelector('[data-value="image_url"]') || el.querySelector('img');
          if (imgEl) { if (product.image_url) imgEl.src = product.image_url; if (product.name) imgEl.alt = product.name; }
          el.querySelectorAll('[data-value="name"]').forEach(node => { node.textContent = product.name || ''; });
          const descEl = el.querySelector('[data-value="description"]'); if (descEl) descEl.textContent = product.description || '';

          // Custom price handling for open_payment
          const priceInput = el.querySelector('[data-role="price-input"]');
          if (priceInput) {
            priceInput.value = product.custom_price;
            priceInput.addEventListener('input', (e) => {
              const val = Number(e.target.value || 0);
              // Update directly on window.productsData
              window.productsData[index].custom_price = isNaN(val) ? 0 : Math.max(0, val);
              console.log('Updated custom_price:', window.productsData[index].custom_price);
              // Update summary if this product is currently selected
              if (window.selectedProductIndex === index) {
                updateSummary();
              }
            });
          }

          el.setAttribute('data-product-id', product.id || '');
          const radio = el.querySelector('input[type="radio"]');
          if (radio) { radio.value = product.id || String(index); radio.name = 'product_selection'; }

          // Klik card untuk memilih
          el.addEventListener('click', (e) => {
            // Prevent click when clicking on input
            if (e.target === priceInput) return;

            // Unselect semua
            container.querySelectorAll('[data-role="product"]').forEach(item => {
              item.classList.remove('border-blue-500', 'shadow-lg');
              const ring = item.querySelector('.w-6.h-6.bg-white');
              const dot = item.querySelector('.w-3.h-3.bg-blue-500');
              if (ring) ring.classList.remove('border-blue-500');
              if (dot) dot.classList.add('scale-0');
              const r = item.querySelector('input[type="radio"]');
              if (r) r.checked = false;
            });

            // Select current
            el.classList.add('border-blue-500', 'shadow-lg');
            const ring = el.querySelector('.w-6.h-6.bg-white');
            const dot = el.querySelector('.w-3.h-3.bg-blue-500');
            if (ring) ring.classList.add('border-blue-500');
            if (dot) dot.classList.remove('scale-0');
            if (radio) radio.checked = true;

            window.selectedProductIndex = index;
            // Update quantity without losing custom_price reference
            window.productsData.forEach((p, i) => {
              p.quantity = (i === index) ? 1 : 0;
            });
            updateSummary();
            if (selectedAddress) calculateShippingCost();
          });

          container.appendChild(el);
        });
      } catch (e) { console.warn('Gagal render produk:', e); }
    })();

    (function initFieldRendering() {
      try {
        const raw = document.body.dataset.fields || '{}';
        const parsed = JSON.parse(raw);
        const fields = Array.isArray(parsed.fields) ? parsed.fields : [];
        const container = document.getElementById('forms');
        const template = container ? container.querySelector('[data-role="field"]') : null;
        if (!container || !template || !fields.length) return;
        const buildFieldHTML = (field) => {
          const el = template.cloneNode(true);
          const labelEl = el.querySelector('[data-value="label"]') || el.querySelector('label');
          const inputEl = el.querySelector('input');
          if (labelEl) { const labelText = field.label || ''; labelEl.innerHTML = `${labelText}${field.required ? ' <span class=\"text-red-500\">*</span>' : ''}`; if (field.id) labelEl.setAttribute('for', field.id); }
          if (inputEl) { if (field.type) inputEl.setAttribute('type', field.type); if (field.id) { inputEl.setAttribute('id', field.id); inputEl.setAttribute('name', field.id); } inputEl.required = !!field.required; let placeholder = inputEl.getAttribute('placeholder') || ''; if (field.type === 'email') placeholder = 'email@example.com'; else if (field.type === 'tel') placeholder = '08xxxxxxxxxx'; else if (field.type === 'text') placeholder = `Masukkan ${String(field.label || '').toLowerCase()}`.trim(); inputEl.setAttribute('placeholder', placeholder); }
          return el.outerHTML;
        };
        container.innerHTML = fields.map(buildFieldHTML).join('');
      } catch (e) { console.warn('Gagal render fields:', e); }
    })();

    function updateSummary() {
      const product = window.productsData && window.productsData[window.selectedProductIndex];
      if (summaryItemsContainer && summaryItemTemplate) {
        if (product) {
          const el = summaryItemTemplate.cloneNode(true);
          el.classList.remove('hidden');
          const nameEl = el.querySelector('[data-summary="name"]');
          const weightEl = el.querySelector('[data-summary="weight"]');
          const lineTotalEl = el.querySelector('[data-summary="line_total"]');
          console.log(product)
          const priceNum = typeof product.custom_price === 'number' ? product.custom_price : (typeof product.price === 'number' ? product.price : parseInt(product.price, 10) || 0);
          const weightNum = product.weight ? (typeof product.weight === 'number' ? product.weight : parseInt(product.weight, 10) || defaultWeight) : defaultWeight;
          if (nameEl) nameEl.textContent = product.name || '';
          if (weightEl) weightEl.textContent = weightNum;
          if (lineTotalEl) lineTotalEl.textContent = priceNum.toLocaleString('id-ID');
          summaryItemsContainer.innerHTML = el.outerHTML;
        } else {
          summaryItemsContainer.innerHTML = '';
        }
      }
      const shippingCostElement = document.getElementById('shippingCost');
      const shippingCost = parseInt((shippingCostElement?.textContent || '').replace(/\./g, '')) || 0;
      const priceNum = product ? (typeof product.custom_price === 'number' ? product.custom_price : (typeof product.price === 'number' ? product.price : parseInt(product.price, 10) || 0)) : 0;
      const total = priceNum + shippingCost;
      if (totalPriceElement) totalPriceElement.textContent = total.toLocaleString('id-ID');
      if (window.customerData) {
        window.customerData.subtotal = priceNum;
        window.customerData.weight = product && product.weight ? (typeof product.weight === 'number' ? product.weight : parseInt(product.weight, 10) || defaultWeight) : defaultWeight;
      }
    }

    (function initCustomerData() {
      window.customerData = { quantity: 1, subtotal: 0, weight: defaultWeight };
    })();

    subdistrictInput.addEventListener('input', function () {
      clearTimeout(debounceTimer);
      const query = this.value.trim();
      if (query.length < 2) { dropdown.classList.add('hidden'); return; }
      debounceTimer = setTimeout(() => searchAddress(query), 500);
    });

    async function searchAddress(query) {
      loadingElement.classList.remove('hidden');
      resultsElement.innerHTML = '';
      dropdown.classList.remove('hidden');
      try {
        const response = await fetch(`${domain}/api/address/search?keyword=${query}`);
        const data = await response.json();
        if (data.success && data.data.length > 0) { displayResults(data.data); }
        else { resultsElement.innerHTML = '<div class="p-3 text-center text-gray-500">Tidak ada hasil</div>'; }
      } catch (error) {
        console.error('Error searching address:', error);
        resultsElement.innerHTML = '<div class="p-3 text-center text-red-500">Terjadi kesalahan</div>';
      } finally { loadingElement.classList.add('hidden'); }
    }

    function displayResults(addresses) {
      resultsElement.innerHTML = addresses.map(addr =>
        `<div onclick="selectAddress('${addr._id}', '${addr.SUBDISTRICT_NAME}', '${addr.DISTRICT_NAME}', '${addr.CITY_NAME}', '${addr.PROVINCE_NAME}', '${addr.ZIP_CODE || ''}')" class="p-3 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-0">${addr.SUBDISTRICT_NAME}, ${addr.DISTRICT_NAME}, ${addr.CITY_NAME}</div>`
      ).join('');
    }

    window.selectAddress = function (id, subdistrict, district, city, province, zipCode) {
      selectedAddress = { id, subdistrict, district, city, province, zipCode };
      subdistrictInput.value = `${subdistrict}, ${district}, ${city}`;
      dropdown.classList.add('hidden');
      window.customerData.subdistrict = subdistrict; window.customerData.district = district; window.customerData.city = city; window.customerData.province = province; window.customerData.zip_code = zipCode; window.customerData.destination_id = id;
      if (courierGuard) courierGuard.classList.add('hidden'); if (courierOptions) courierOptions.classList.remove('hidden'); if (courierLoadingEl) courierLoadingEl.classList.remove('hidden');
      calculateShippingCost();
    };

    async function calculateShippingCost() {
      const product = window.productsData && window.productsData[window.selectedProductIndex];
      if (!selectedAddress || !product) { const shippingInfo = document.getElementById('shippingInfo'); courierOptions && courierOptions.classList.remove('hidden'); courierGuard && courierGuard.classList.remove('hidden'); courierLoadingEl && courierLoadingEl.classList.add('hidden'); shippingInfo && shippingInfo.classList.add('hidden'); return; }
      const weight = product.weight ? (typeof product.weight === 'number' ? product.weight : parseInt(product.weight, 10) || defaultWeight) : defaultWeight;
      const destinationId = selectedAddress.id;
      try {
        courierGuard && courierGuard.classList.add('hidden'); courierOptions && courierOptions.classList.remove('hidden'); courierLoadingEl && courierLoadingEl.classList.remove('hidden');
        const response = await fetch(`${domain}/api/address/shipping-estimate?origin_id=${originId}&destination_id=${destinationId}&weight=${weight}`);
        const data = await response.json();
        if (data.success) { displayCourierOptions(data.data); }
      } catch (error) { console.error('Error calculating shipping cost:', error); }
      finally { courierLoadingEl && courierLoadingEl.classList.add('hidden'); }
    }

      function displayCourierOptions(shippingData) {
        // allowedCouriers akan dibaca dari body[data-couriers] jika tersedia, fallback ke daftar default
        const allowedCouriers = (() => {
          const defaultList = ["JNE", "JNECargo", "SiCepat", "SiCepatCargo", "SAP", "SapCargo", "iDexpress", "JT", "lion", "iDexpressCargo", "paxel", "Ninja"];
          const raw = (document.body && document.body.dataset && document.body.dataset.couriers) || '';
          if (!raw) return defaultList;
          try {
            const parsed = JSON.parse(raw.replace(/'/g, '"'));
            return Array.isArray(parsed) ? parsed : defaultList;
          } catch {
            const arr = raw.split(',').map(s => s.trim()).filter(Boolean);
            return arr.length ? arr : defaultList;
          }
        })();
        const preSelectedCourier = (window.customerData && window.customerData.courier_name) || null;
      courierLoadingEl && courierLoadingEl.classList.add('hidden');
      let template = courierList ? courierList.querySelector('#courierItemTemplate') : null;
      if (!template && window.courierItemTemplate) { template = window.courierItemTemplate; }
      if (template) { window.courierItemTemplate = template; Array.from(courierList.children).forEach(child => { if (child.id !== 'courierItemTemplate' && child.id !== 'courierLoading') child.remove(); }); }
      else { courierList.innerHTML = ''; }
      let hasValidCourier = false;
      Object.entries(shippingData).forEach(([courier, details]) => {
        if (allowedCouriers.includes(courier) && details.price > 0) {
          hasValidCourier = true;
          let el; const inputId = `courier-${courier}`;
          if (template) {
            el = template.cloneNode(true); el.id = ''; el.classList.remove('hidden');
            const inputEl = el.querySelector('input[type="radio"]'); const labelEl = el.querySelector('label'); const nameEl = el.querySelector('[data-field="name"]'); const priceEl = el.querySelector('[data-field="price"]'); const etaEl = el.querySelector('[data-field="eta"]');
            if (inputEl) { inputEl.id = inputId; inputEl.name = 'courier'; inputEl.value = courier; if (preSelectedCourier === courier) inputEl.checked = true; }
            if (labelEl) labelEl.setAttribute('for', inputId);
            if (nameEl) nameEl.textContent = courier;
            if (priceEl) priceEl.textContent = `Rp ${details.price.toLocaleString('id-ID')}`;
            if (etaEl) etaEl.textContent = details.estimatedDate || '-';
            el.addEventListener('click', function () { if (inputEl) inputEl.checked = true; selectCourier(courier, details.price); });
          } else {
            const courierDiv = document.createElement('div');
            courierDiv.className = 'flex items-center p-3 border-2 border-gray-200 rounded-lg hover:border-blue-300 transition-colors cursor-pointer';
            courierDiv.innerHTML = `
              <input type="radio" id="${inputId}" name="courier" value="${courier}" class="mr-3 w-4 h-4 text-blue-600 focus:ring-blue-500">
              <label for="${inputId}" class="flex-1 cursor-pointer">
                <div class="flex justify-between items-center">
                  <span class="font-medium">${courier}</span>
                  <span class="text-blue-600 font-semibold">Rp ${details.price.toLocaleString('id-ID')}</span>
                </div>
                <div class="text-sm text-gray-500">Estimasi: ${details.estimatedDate}</div>
              </label>`;
            courierDiv.addEventListener('click', function () { document.getElementById(inputId).checked = true; selectCourier(courier, details.price); });
            if (preSelectedCourier === courier) { const radio = courierDiv.querySelector('input[type="radio"]'); if (radio) radio.checked = true; }
            el = courierDiv;
          }
          courierList.appendChild(el);
        }
      });
      if (hasValidCourier) { courierOptions.classList.remove('hidden'); if (preSelectedCourier && shippingData[preSelectedCourier] && shippingData[preSelectedCourier].price > 0) { selectCourier(preSelectedCourier, shippingData[preSelectedCourier].price); } }
    }

    function selectCourier(courier, price) {
      window.customerData.courier_name = courier; window.customerData.shipping_cost = price;
      const shippingInfo = document.getElementById('shippingInfo'); const shippingAddress = document.getElementById('shippingAddress'); const selectedCourier = document.getElementById('selectedCourier'); const shippingCost = document.getElementById('shippingCost');
      shippingInfo.classList.remove('hidden'); shippingAddress.textContent = window.customerData.address || 'Alamat lengkap'; selectedCourier.textContent = courier; shippingCost.textContent = price.toLocaleString('id-ID');
      const product = window.productsData && window.productsData[window.selectedProductIndex];
      const priceNum = product ? (typeof product.custom_price === 'number' ? product.custom_price : (typeof product.price === 'number' ? product.price : parseInt(product.price, 10) || 0)) : 0;
      const total = priceNum + price; totalPriceElement.textContent = total.toLocaleString('id-ID');
      document.getElementById('courierError').classList.add('hidden');
    }

    orderForm.addEventListener('submit', async function (e) {
      e.preventDefault();
      const formId = document.body.dataset.formId
      const product = window.productsData && window.productsData[window.selectedProductIndex];
      if (!product) { alert('Silakan pilih salah satu produk terlebih dahulu.'); return; }
      let fields = []; try { const rawFields = document.body.dataset.fields || '{}'; const parsedFields = JSON.parse(rawFields); fields = Array.isArray(parsedFields.fields) ? parsedFields.fields : []; } catch (err) { }
      const formValues = {}; const missingRequired = []; fields.forEach(f => { const el = document.getElementById(f.id) || orderForm.querySelector(`[name="${f.id}"]`); const val = el ? (el.value || '').trim() : ''; formValues[f.id] = val; if (f.required && !val) missingRequired.push(f.label || f.id); });
      if (missingRequired.length) { alert('Mohon lengkapi field wajib: ' + missingRequired.join(', ')); return; }
      if (!selectedAddress) { alert('Mohon pilih desa/kelurahan'); return; }
      if (!window.customerData.courier_name) { document.getElementById('courierError').classList.remove('hidden'); return; }
      Object.assign(window.customerData, formValues);
      const addrVal = formValues.address || document.getElementById('address')?.value?.trim() || '';
      window.customerData.address = addrVal; window.customerData.full_address = `${addrVal}, ${selectedAddress.subdistrict}, ${selectedAddress.district}, ${selectedAddress.city}, ${selectedAddress.province}`;
      const priceNum = typeof product.custom_price === 'number' ? product.custom_price : (typeof product.price === 'number' ? product.price : parseInt(product.price, 10) || 0);
      window.customerData.subtotal = priceNum;
      const weight = product.weight ? (typeof product.weight === 'number' ? product.weight : parseInt(product.weight, 10) || defaultWeight) : defaultWeight;
      window.customerData.weight = weight;
      const shippingCost = window.customerData.shipping_cost || 0;
      const total = priceNum + shippingCost;
      const productData = { id: product.id || 'SKU-1', code: product.id || 'SKU-1', name: product.name || 'Produk', price: priceNum, quantity: 1, is_addon: !!product.is_addon };
      const urlParams = new URLSearchParams(window.location.search);
      const utmSource = urlParams.get('utm_source') || ''; const utmMedium = urlParams.get('utm_medium') || ''; const utmCampaign = urlParams.get('utm_campaign') || ''; const utmContent = urlParams.get('utm_content') || '';
      const submissionData = { customer_data: { ...window.customerData, utm_meta: { utm_source: utmSource, utm_medium: utmMedium, utm_campaign: utmCampaign, utm_content: utmContent } }, subtotal: priceNum, total: total, product: [productData] };
      submitBtn.disabled = true; submitBtn.textContent = 'Memproses...'; submitBtn.classList.add('opacity-75', 'cursor-not-allowed');
      try {
        const response = await fetch(`${domain}/form/${formId}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(submissionData) });
        if (typeof fbq !== 'undefined') { fbq('track', submitEvent, { value: total, currency: 'IDR' }); }
        if (typeof ttq !== 'undefined') { ttq.track(submitEvent, { value: total, currency: 'IDR' }); }
        if (typeof twq !== 'undefined') { twq('event', submitEvent, { value: total, currency: 'IDR' }); }
        const result = await response.json();
        if (result.id) {
          successMessage.classList.remove('hidden');
          setTimeout(() => { successContent.classList.remove('scale-95', 'opacity-0'); successContent.classList.add('scale-100', 'opacity-100'); let width = 0; const interval = setInterval(() => { width += 10; progressBar.style.width = width + '%'; if (width >= 100) { clearInterval(interval); window.location.href = `${domain}/invoice/${result.id}`; } }, 100); }, 100);
        } else { throw new Error('Failed to submit order'); }
      } catch (error) { console.error('Error submitting order:', error); alert('Terjadi kesalahan saat mengirim pesanan. Silakan coba lagi.'); submitBtn.disabled = false; submitBtn.textContent = 'Selesaikan Pesanan'; submitBtn.classList.remove('opacity-75', 'cursor-not-allowed'); }
    });

    document.addEventListener('click', function (e) {
      if (!subdistrictInput.contains(e.target) && !dropdown.contains(e.target)) {
        dropdown.classList.add('hidden');
      }
    });

    subdistrictInput.addEventListener('keydown', function (e) {
      const results = resultsElement.querySelectorAll('div');
      if (results.length === 0) return;

      let currentIndex = -1;
      results.forEach((result, index) => {
        if (result.classList.contains('bg-blue-100')) {
          currentIndex = index;
        }
      });

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (currentIndex < results.length - 1) {
          if (currentIndex >= 0) {
            results[currentIndex].classList.remove('bg-blue-100');
          }
          results[currentIndex + 1].classList.add('bg-blue-100');
        }
      }
      else if (e.key === 'ArrowUp') {
        e.preventDefault();
        if (currentIndex > 0) {
          results[currentIndex].classList.remove('bg-blue-100');
        }
        results[currentIndex - 1].classList.add('bg-blue-100');
      }
      else if (e.key === 'Enter') {
        e.preventDefault();
        if (currentIndex >= 0) {
          results[currentIndex].click();
        }
      }
      else if (e.key === 'Escape') {
        dropdown.classList.add('hidden');
      }
    });

    // Initialize
    updateSummary();
  </script>
</section>
<section class="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 py-8 px-4 sm:px-6 lg:px-8">
  <div class="w-full max-w-sm sm:max-w-md md:max-w-2xl lg:max-w-3xl mx-auto">
    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold text-gray-900 mb-2 hover-highlight custom-cursor">Form order A</h1>
      <p class="text-gray-600 hover-highlight custom-cursor">Beli produk anda disini</p>
    </div>

    <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
      <form id="orderForm" class="p-6 sm:p-8 lg:p-10">
        <!-- Stepper -->
        <div id="msStepper" class="mb-6">
          <div class="flex items-center justify-between">
            <div class="flex-1 flex flex-col items-center">
              <div
                class="w-9 h-9 rounded-full flex items-center justify-center border-2 border-indigo-500 text-indigo-600 font-bold"
                data-step-circle="0">1</div>
              <div class="mt-2 text-xs sm:text-sm font-medium text-indigo-600" data-step-label="0">Produk</div>
            </div>
            <div class="flex-1 h-0.5 bg-indigo-200 mx-2" data-step-line="0"></div>
            <div class="flex-1 flex flex-col items-center">
              <div
                class="w-9 h-9 rounded-full flex items-center justify-center border-2 border-gray-300 text-gray-400 font-bold"
                data-step-circle="1">2</div>
              <div class="mt-2 text-xs sm:text-sm font-medium text-gray-400" data-step-label="1">Identitas</div>
            </div>
            <div class="flex-1 h-0.5 bg-indigo-200 mx-2" data-step-line="1"></div>
            <div class="flex-1 flex flex-col items-center">
              <div
                class="w-9 h-9 rounded-full flex items-center justify-center border-2 border-gray-300 text-gray-400 font-bold"
                data-step-circle="2">3</div>
              <div class="mt-2 text-xs sm:text-sm font-medium text-gray-400" data-step-label="2">Ringkasan</div>
            </div>
          </div>
        </div>

        <!-- Produk: Selection List -->
        <div data-role="parent" class="mb-8 sm:mb-10 hover-highlight custom-cursor">
          <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center hover-highlight custom-cursor">
            <span
              class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold text-sm mr-2 hover-highlight custom-cursor">1</span>
            Pilih Produk
          </h2>
          <div class="flex flex-col gap-4" id="products">
            <div
              class="bg-white rounded-xl p-4 border-2 border-transparent transition-all duration-300 cursor-pointer shadow-md hover:shadow-lg hover:border-blue-500"
              data-placeholder="true" data-role="product" data-template="product">
              <div class="flex flex-row gap-4 items-center">
                <div class="flex-shrink-0">
                  <img data-value="image_url" src="https://placehold.co/300x300/e2e8f0/64748b?text=Produk" alt="Produk"
                    class="w-24 h-24 object-cover rounded-lg shadow-md border border-gray-200">
                </div>
                <div class="w-full min-w-0">
                  <div class="flex justify-between items-start mb-1">
                    <h3 class="text-lg font-bold text-gray-900" data-value="name">Nama Produk</h3>
                    <div
                      class="w-6 h-6 bg-white rounded-full border-2 border-gray-300 flex items-center justify-center transition-all duration-300 flex-shrink-0 ml-4">
                      <div class="w-3 h-3 bg-blue-500 rounded-full transform scale-0 transition-all duration-300"></div>
                    </div>
                  </div>
                  <p class="text-sm text-gray-500 mt-1 truncate" data-value="description">Deskripsi produk</p>
                  <div class="flex items-center justify-between mt-3">
                    <span class="text-lg font-bold text-blue-600" data-value="price">Rp 0</span>
                    <span class="text-sm text-gray-500">200g</span>
                  </div>
                </div>
                <input type="checkbox" name="product_selection[]" class="hidden">
              </div>
            </div>
          </div>
        </div>

        <!-- Identitas -->
        <div data-role="parent" class="mb-8 sm:mb-10">
          <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
            <span
              class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold text-sm mr-2">2</span>
            Informasi Identitas
          </h2>
          <div class="space-y-6" id="forms">
            <div data-role="field" data-template="field">
              <label class="block text-base sm:text-sm font-medium text-gray-700 mb-2" data-value="label">Nama</label>
              <input type="text"
                class="w-full px-4 py-4 sm:py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-base" />
            </div>
          </div>
        </div>

        <!-- Ringkasan -->
        <div data-role="parent" class="mb-8 sm:mb-10">
          <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
            <span
              class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold text-sm mr-2">3</span>
            Ringkasan Pesanan
          </h2>
          <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 border border-blue-100">
            <div class="space-y-4">
              <div id="summaryItems" class="space-y-3"></div>
              <div id="summaryItemTemplate" data-template="summary-item" data-role="summary-item"
                class="flex justify-between items-center pb-3 border-b border-blue-100 hidden" data-placeholder="true">
                <div>
                  <h3 class="font-semibold text-gray-900" data-summary="name">Produk</h3>
                  <p class="text-sm text-gray-500">Berat: <span data-summary="weight">0</span>g</p>
                </div>
                <div class="text-right">
                  <p class="text-sm text-gray-500">Rp <span data-summary="unit_price">0</span> Ã— <span
                      data-summary="qty">1</span></p>
                  <p class="font-semibold text-gray-900">Rp <span data-summary="line_total">0</span></p>
                </div>
              </div>
              <div class="flex justify-between items-center">
                <h3 class="text-lg font-bold text-gray-900">Total</h3>
                <p class="text-xl font-bold text-blue-600">Rp <span id="totalPrice">0</span></p>
              </div>
            </div>
          </div>
        </div>

        <!-- Nav -->
        <div id="msNav" class="flex justify-between items-center gap-3 mt-2 mb-4">
          <button type="button" id="prevStep"
            class="px-6 py-3 rounded-lg border border-indigo-300 text-indigo-700 bg-indigo-50 hover:bg-indigo-100">Sebelumnya</button>
          <button type="button" id="nextStep"
            class="px-6 py-3 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">Lanjut</button>
        </div>

        <!-- Submit -->
        <div class="flex justify-center">
          <button type="submit" id="submitBtn"
            class="w-full sm:w-auto px-8 py-5 sm:py-4 bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-bold rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300 min-h-14 sm:min-h-12 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">Selesaikan
            Pesanan</button>
        </div>
      </form>
    </div>
  </div>
  <!-- Success Message -->
  <div id="successMessage" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-8 max-w-md mx-4 transform transition-all duration-300 scale-95 opacity-0"
      id="successContent">
      <div class="text-center">
        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-500" viewBox="0 0 20 20"
            fill="currentColor">
            <path fill-rule="evenodd"
              d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
              clip-rule="evenodd"></path>
          </svg>
        </div>
        <h3 class="text-xl font-bold text-gray-900 mb-2">Pesanan Berhasil!</h3>
        <p class="text-gray-600 mb-6">Terima kasih telah melakukan pemesanan. Anda akan diarahkan ke halaman pembayaran.
        </p>
        <div class="w-full bg-gray-200 rounded-full h-2">
          <div class="bg-blue-600 h-2 rounded-full" id="progressBar" style="width: 0%"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const state = { products: [], fields: [], formValues: {}, totalWeight: 0, totalPrice: 0 };
      function formatCurrency(amount) { return new Intl.NumberFormat('id-ID').format(amount); }
      function getData(key) { return document.body.dataset[key] || ''; }

      function initializeData() {
        state.products = JSON.parse((getData('products') || '[]'));
        const fieldsParsed = JSON.parse((getData('fields') || '{}'));
        state.fields = Array.isArray(fieldsParsed.fields) ? fieldsParsed.fields : [];
      }

      function renderProducts() {
        const productContainer = document.getElementById('products');
        const productTemplate = productContainer.querySelector('[data-template="product"]');
        productContainer.innerHTML = '';
        state.products.forEach(product => {
          const productEl = productTemplate.cloneNode(true);
          productEl.dataset.productId = product.id;
          const nameEl = productEl.querySelector('[data-value="name"]');
          const descEl = productEl.querySelector('[data-value="description"]');
          const priceEl = productEl.querySelector('[data-value="price"]');
          const imgEl = productEl.querySelector('[data-value="image_url"]');
          const checkbox = productEl.querySelector('input[type="checkbox"]');
          if (nameEl) nameEl.textContent = product.name;
          if (descEl) descEl.textContent = product.description || '';
          if (priceEl) priceEl.textContent = `Rp ${formatCurrency(product.price || 0)}`;
          if (imgEl) imgEl.src = product.image_url || 'https://placehold.co/300x300/e2e8f0/64748b?text=Produk';
          if (checkbox) checkbox.value = product.id;

          productEl.addEventListener('click', () => {
            // Toggle current selection (allow multi-select)
            const circle = productEl.querySelector('.w-6.h-6.bg-white');
            const dot = productEl.querySelector('.w-3.h-3.bg-blue-500');
            const isSelected = checkbox ? checkbox.checked : false;

            const nextSelected = !isSelected;
            if (checkbox) checkbox.checked = nextSelected;

            if (nextSelected) {
              productEl.classList.add('border-blue-500', 'shadow-lg');
              if (circle) circle.classList.add('border-blue-500');
              if (dot) dot.classList.remove('scale-0');
              product.quantity = 1; // default quantity per selected product
            } else {
              productEl.classList.remove('border-blue-500', 'shadow-lg');
              if (circle) circle.classList.remove('border-blue-500');
              if (dot) dot.classList.add('scale-0');
              product.quantity = 0;
            }

            updateSummary();
          });
          productContainer.appendChild(productEl);
        });
      }

      function renderForms() {
        const formsContainer = document.getElementById('forms');
        const fieldTemplate = formsContainer.querySelector('[data-template="field"]');
        formsContainer.innerHTML = '';
        state.fields.forEach(field => {
          const fieldEl = fieldTemplate.cloneNode(true);
          const label = fieldEl.querySelector('[data-value="label"]');
          const input = fieldEl.querySelector('input');
          if (label) {
            label.textContent = field.label;
            if (field.required) label.innerHTML += ' <span class="text-red-500">*</span>';
          }
          if (input) {
            input.id = field.id; input.name = field.id;
            input.type = field.type || 'text'; input.required = !!field.required;
            input.placeholder = `Masukkan ${String(field.label || '').toLowerCase()}`;
          }
          formsContainer.appendChild(fieldEl);
        });
      }

      function updateSummary() {
        const summaryItemsContainer = document.getElementById('summaryItems');
        const summaryItemTemplate = document.getElementById('summaryItemTemplate');
        summaryItemsContainer.innerHTML = '';
        const selectedProducts = state.products.filter(p => (p.quantity || 0) > 0);
        let subtotal = 0;
        selectedProducts.forEach(sp => {
          const itemEl = summaryItemTemplate.cloneNode(true);
          itemEl.classList.remove('hidden');
          itemEl.querySelector('[data-summary="name"]').textContent = sp.name;
          const weight = (typeof sp.weight !== 'undefined' && sp.weight !== null) ? sp.weight : 200;
          itemEl.querySelector('[data-summary="weight"]').textContent = weight;
          const unitPrice = sp.price || 0;
          const qty = sp.quantity || 1;
          itemEl.querySelector('[data-summary="unit_price"]').textContent = formatCurrency(unitPrice);
          itemEl.querySelector('[data-summary="qty"]').textContent = qty;
          itemEl.querySelector('[data-summary="line_total"]').textContent = formatCurrency(unitPrice * qty);
          summaryItemsContainer.appendChild(itemEl);
          subtotal += unitPrice * qty;
        });
        state.totalPrice = subtotal;
        document.getElementById('totalPrice').textContent = formatCurrency(state.totalPrice);
      }

      // Init
      initializeData();
      renderProducts();
      renderForms();
      updateSummary();

      // Multi-step
      (function initMultiStep() {
        const parents = Array.from(document.querySelectorAll('#orderForm [data-role="parent"]'));
        const prevStepBtn = document.getElementById('prevStep');
        const nextStepBtn = document.getElementById('nextStep');
        const submitBtnEl = document.getElementById('submitBtn');
        const stepCircles = Array.from(document.querySelectorAll('[data-step-circle]'));
        const stepLabels = Array.from(document.querySelectorAll('[data-step-label]'));
        let stepIndex = 0;
        function refreshStepperUI() {
          stepCircles.forEach((c, idx) => {
            if (idx <= stepIndex) { c.classList.remove('border-gray-300', 'text-gray-400'); c.classList.add('border-indigo-500', 'text-indigo-600'); }
            else { c.classList.add('border-gray-300', 'text-gray-400'); c.classList.remove('border-indigo-500', 'text-indigo-600'); }
          });
          stepLabels.forEach((l, idx) => {
            if (idx === stepIndex) { l.classList.remove('text-gray-400'); l.classList.add('text-indigo-600'); }
            else { l.classList.add('text-gray-400'); l.classList.remove('text-indigo-600'); }
          });
        }
        function showStep(i) {
          stepIndex = Math.max(0, Math.min(i, parents.length - 1));
          parents.forEach((el, idx) => el.classList.toggle('hidden', idx !== stepIndex));
          prevStepBtn.disabled = stepIndex === 0;
          prevStepBtn.classList.toggle('opacity-50', stepIndex === 0);
          nextStepBtn.classList.toggle('hidden', stepIndex === parents.length - 1);
          if (submitBtnEl) submitBtnEl.classList.toggle('hidden', stepIndex !== parents.length - 1);
          refreshStepperUI();
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        prevStepBtn.addEventListener('click', () => showStep(stepIndex - 1));
        nextStepBtn.addEventListener('click', () => { updateSummary(); showStep(stepIndex + 1); });
        showStep(0);
      })();

      // Form submission logic
      const orderForm = document.getElementById('orderForm');
      const submitBtn = document.getElementById('submitBtn');
      const successMessage = document.getElementById('successMessage');
      const successContent = document.getElementById('successContent');
      const progressBar = document.getElementById('progressBar');

      orderForm.addEventListener('submit', async function (e) {
        e.preventDefault();

        // Get selected products (multi-select)
        const selectedProducts = state.products.filter(p => (p.quantity || 0) > 0);
        if (!selectedProducts.length) {
          alert('Silakan pilih setidaknya satu produk terlebih dahulu.');
          return;
        }

        // Get form data
        const formData = {};
        const missingRequired = [];

        state.fields.forEach(field => {
          const input = document.getElementById(field.id) || orderForm.querySelector(`[name="${field.id}"]`);
          const value = input ? (input.value || '').trim() : '';
          formData[field.id] = value;

          if (field.required && !value) {
            missingRequired.push(field.label || field.id);
          }
        });

        // Validate required fields
        if (missingRequired.length) {
          alert('Mohon lengkapi field wajib: ' + missingRequired.join(', '));
          return;
        }

        // Prepare submission data
        const domain = document.body.dataset.domain || '';
        const formId = document.body.dataset.formId || '';
        const submitEvent = document.body.dataset.submitEvent || '';

        const productList = selectedProducts.map(p => ({
          id: p.id,
          code: p.id,
          name: p.name,
          price: p.price || 0,
          quantity: p.quantity || 1,
          is_addon: !!p.is_addon
        }));
        const priceNum = productList.reduce((sum, item) => sum + (item.price * item.quantity), 0);

        // Get UTM parameters
        const urlParams = new URLSearchParams(window.location.search);
        const utmSource = urlParams.get('utm_source') || '';
        const utmMedium = urlParams.get('utm_medium') || '';
        const utmCampaign = urlParams.get('utm_campaign') || '';
        const utmContent = urlParams.get('utm_content') || '';

        const submissionData = {
          customer_data: {
            ...formData,
            utm_meta: {
              utm_source: utmSource,
              utm_medium: utmMedium,
              utm_campaign: utmCampaign,
              utm_content: utmContent
            }
          },
          subtotal: priceNum,
          total: priceNum,
          product: productList
        };

        // Disable submit button
        submitBtn.disabled = true;
        submitBtn.textContent = 'Memproses...';
        submitBtn.classList.add('opacity-75', 'cursor-not-allowed');

        try {
          // Track conversion events
          if (typeof fbq !== 'undefined') {
            fbq('track', submitEvent, { value: priceNum, currency: 'IDR' });
          }
          if (typeof ttq !== 'undefined') {
            ttq.track(submitEvent, { value: priceNum, currency: 'IDR' });
          }
          if (typeof twq !== 'undefined') {
            twq('event', submitEvent, { value: priceNum, currency: 'IDR' });
          }

          // Submit form
          const response = await fetch(`${domain}/form/${formId}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(submissionData)
          });

          const result = await response.json();

          if (result.id) {
            // Show success message
            successMessage.classList.remove('hidden');
            setTimeout(() => {
              successContent.classList.remove('scale-95', 'opacity-0');
              successContent.classList.add('scale-100', 'opacity-100');

              // Progress bar animation
              let width = 0;
              const interval = setInterval(() => {
                width += 10;
                progressBar.style.width = width + '%';
                if (width >= 100) {
                  clearInterval(interval);
                  // Redirect to invoice page
                  window.location.href = `${domain}/invoice/${result.id}`;
                }
              }, 100);
            }, 100);
          } else {
            throw new Error('Failed to submit order');
          }
        } catch (error) {
          console.error('Error submitting order:', error);
          alert('Terjadi kesalahan saat mengirim pesanan. Silakan coba lagi.');

          // Re-enable submit button
          submitBtn.disabled = false;
          submitBtn.textContent = 'Selesaikan Pesanan';
          submitBtn.classList.remove('opacity-75', 'cursor-not-allowed');
        }
      });
    });
  </script>
</section>
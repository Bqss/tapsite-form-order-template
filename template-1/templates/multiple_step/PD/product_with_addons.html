<section class="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 py-8 px-4 sm:px-6 lg:px-8">
  <div class="w-full max-w-sm sm:max-w-md md:max-w-2xl lg:max-w-3xl mx-auto">
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold text-gray-900 mb-2">Form order A</h1>
      <p class="text-gray-600">Beli produk anda disini</p>
    </div>

    <!-- Form Container -->
    <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
      <form id="orderForm" class="p-6 sm:p-8 lg:p-10">
        <!-- Stepper -->
        <div id="msStepper" class="mb-6">
          <div class="flex items-center justify-between">
            <div class="flex-1 flex flex-col items-center">
              <div
                class="w-9 h-9 rounded-full flex items-center justify-center border-2 border-indigo-500 text-indigo-600 font-bold"
                data-step-circle="0">1</div>
              <div class="mt-2 text-xs sm:text-sm font-medium text-indigo-600" data-step-label="0">Produk</div>
            </div>
            <div class="flex-1 h-0.5 bg-indigo-200 mx-2" data-step-line="0"></div>
            <div class="flex-1 flex flex-col items-center">
              <div
                class="w-9 h-9 rounded-full flex items-center justify-center border-2 border-gray-300 text-gray-400 font-bold"
                data-step-circle="1">2</div>
              <div class="mt-2 text-xs sm:text-sm font-medium text-gray-400" data-step-label="1">Identitas</div>
            </div>
            <div class="flex-1 h-0.5 bg-indigo-200 mx-2" data-step-line="1"></div>
            <div class="flex-1 flex flex-col items-center">
              <div
                class="w-9 h-9 rounded-full flex items-center justify-center border-2 border-gray-300 text-gray-400 font-bold"
                data-step-circle="2">3</div>
              <div class="mt-2 text-xs sm:text-sm font-medium text-gray-400" data-step-label="2">Ringkasan</div>
            </div>
          </div>
        </div>

        <!-- Produk & Addons -->
        <div data-role="parent" class="mb-8 sm:mb-10">
          <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
            <span
              class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold text-sm mr-2">1</span>
            Produk
          </h2>

          <div class="flex flex-col gap-2" id="products">
            <div
              class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-4 space-y-2 sm:p-6 border border-blue-100"
              data-role="product" data-template="product">
              <div class="flex flex-col sm:flex-row gap-3 sm:gap-4">
                <div class="w-full sm:w-1/3 flex-shrink-0">
                  <img data-value="image_url" src="https://placehold.co/300x300/e2e8f0/64748b?text=Produk" alt="Produk"
                    class="w-full h-32 sm:h-48 object-cover rounded-lg shadow-md">
                </div>
                <div class="w-full sm:w-2/3 min-w-0">
                  <h3 class="text-lg sm:text-xl font-bold text-gray-900 mb-1 sm:mb-2" data-value="name">Produk</h3>
                  <p class="text-sm sm:text-base text-gray-600 mb-3 sm:mb-4" data-value="description">Deskripsi</p>
                  <div class="flex flex-col gap-3 mb-3 sm:mb-4">
                    <div class="flex items-center justify-between">
                      <span class="text-xl sm:text-2xl font-bold text-blue-600" data-value="price">Rp 0</span>
                    </div>
                  </div>
                  <div class="flex items-center text-xs sm:text-sm text-gray-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 sm:h-5 sm:w-5 mr-1" viewBox="0 0 20 20"
                      fill="currentColor">
                      <path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z">
                      </path>
                      <path
                        d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0H10a1 1 0 001-1V5a1 1 0 00-1-1H3zM14 7a1 1 0 00-1 1v6.05A2.5 2.5 0 0115.95 16H17a1 1 0 001-1v-5a1 1 0 00-.293-.707l-2-2A1 1 0 0015 7h-1z">
                      </path>
                    </svg>
                    <span class="hidden sm:inline">Berat: </span>200g per item
                  </div>
                </div>
              </div>
            </div>

            <!-- Addons (Opsional) -->
            <div class="mt-4">
              <h3 class="text-base sm:text-lg font-semibold text-gray-900 mb-2">Tambahan (Opsional)</h3>
              <div id="addonsList" class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                <div id="addonItemTemplate" data-role="addon-item" data-template="addon-item" class="hidden">
                  <label
                    class="flex items-start gap-3 p-3 border-2 border-gray-200 rounded-lg hover:border-blue-300 transition-colors cursor-pointer">
                    <input type="checkbox" class="mt-1 w-4 h-4 text-blue-600 focus:ring-blue-500" />
                    <div class="flex-1">
                      <div class="flex justify-between items-start">
                        <span class="font-medium" data-field="name">Nama Addon</span>
                        <span class="text-blue-600 font-semibold" data-field="price">Rp 0</span>
                      </div>
                      <p class="text-xs text-gray-500" data-field="description"></p>
                    </div>
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Identitas -->
        <div data-role="parent" class="mb-8 sm:mb-10">
          <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
            <span
              class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold text-sm mr-2">2</span>
            Informasi Identitas
          </h2>
          <div class="space-y-6" id="forms">
            <div data-role="field" data-template="field">
              <label class="block text-base sm:text-sm font-medium text-gray-700 mb-2" data-value="label">Nama</label>
              <input type="text"
                class="w-full px-4 py-4 sm:py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-base" />
            </div>
          </div>
        </div>

        <!-- Ringkasan -->
        <div data-role="parent" class="mb-8 sm:mb-10">
          <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
            <span
              class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold text-sm mr-2">3</span>
            Ringkasan Pesanan
          </h2>
          <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 border border-blue-100">
            <div class="space-y-4">
              <div id="summaryItems" class="space-y-3"></div>
              <div id="summaryItemTemplate" data-template="summary-item" data-role="summary-item"
                class="flex justify-between items-center pb-3 border-b border-blue-100 hidden" data-placeholder="true">
                <div>
                  <h3 class="font-semibold text-gray-900" data-summary="name">Produk</h3>
                  <p class="text-sm text-gray-500">Berat: <span data-summary="weight">0</span>g</p>
                </div>
                <div class="text-right">
                  <p class="text-sm text-gray-500">Rp <span data-summary="unit_price">0</span> Ã— <span
                      data-summary="qty">1</span></p>
                  <p class="font-semibold text-gray-900">Rp <span data-summary="line_total">0</span></p>
                </div>
              </div>
              <div class="flex justify-between items-center">
                <h3 class="text-lg font-bold text-gray-900">Total</h3>
                <p class="text-xl font-bold text-blue-600">Rp <span id="totalPrice">0</span></p>
              </div>
            </div>
          </div>
        </div>

        <!-- Nav -->
        <div id="msNav" class="flex justify-between items-center gap-3 mt-2 mb-4">
          <button type="button" id="prevStep"
            class="px-6 py-3 rounded-lg border border-indigo-300 text-indigo-700 bg-indigo-50 hover:bg-indigo-100">Sebelumnya</button>
          <button type="button" id="nextStep"
            class="px-6 py-3 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">Lanjut</button>
        </div>

        <!-- Submit -->
        <div class="flex justify-center">
          <button type="submit" id="submitBtn"
            class="w-full sm:w-auto px-8 py-5 sm:py-4 bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-bold rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300 min-h-14 sm:min-h-12 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">Selesaikan
            Pesanan</button>
        </div>
      </form>
    </div>

    <!-- Success Message -->
    <div id="successMessage" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-xl p-8 max-w-md mx-4 transform transition-all duration-300 scale-95 opacity-0"
        id="successContent">
        <div class="text-center">
          <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-500" viewBox="0 0 20 20"
              fill="currentColor">
              <path fill-rule="evenodd"
                d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                clip-rule="evenodd"></path>
            </svg>
          </div>
          <h3 class="text-xl font-bold text-gray-900 mb-2">Pesanan Berhasil!</h3>
          <p class="text-gray-600 mb-6">Terima kasih telah melakukan pemesanan. Anda akan diarahkan ke halaman
            pembayaran.</p>
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div class="bg-blue-600 h-2 rounded-full" id="progressBar" style="width: 0%"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const domain = document.body.dataset.domain || '';
    const originId = document.body.dataset.originId || '';

    const productsContainer = document.getElementById('products');
    const summaryItemsContainer = document.getElementById('summaryItems');
    const summaryItemTemplate = document.getElementById('summaryItemTemplate');
    const totalPriceElement = document.getElementById('totalPrice');

    const PRODUCT_WEIGHT = 200;

    const orderForm = document.getElementById('orderForm');
    const submitBtn = document.getElementById('submitBtn');
    const successMessage = document.getElementById('successMessage');
    const successContent = document.getElementById('successContent');
    const progressBar = document.getElementById('progressBar');

    // Initialize customer data object
    window.customerData = {
      quantity: 1,
      subtotal: 0,
      weight: PRODUCT_WEIGHT,
      shipping_cost: 0
    };

    (function initProductRendering() {
      try {
        const raw = document.body.dataset.products || '[]';
        const products = JSON.parse(raw.replace(/'/g, '"'));
        const baseProduct = products.find(p => !p.is_addon);
        const addons = products.filter(p => p.is_addon);

        const container = document.getElementById('products');
        const template = container ? container.querySelector('[data-role="product"]') : null;
        if (!container || !template || !baseProduct) return;

        const buildProductHTML = (product) => {
          const el = template.cloneNode(true);
          const imgEl = el.querySelector('[data-value="image_url"]') || el.querySelector('img');
          if (imgEl) {
            imgEl.src = product.image_url || 'https://placehold.co/300x300/e2e8f0/64748b?text=Produk';
            imgEl.alt = product.name || 'Produk';
          }
          el.querySelectorAll('[data-value="name"]').forEach(node => node.textContent = product.name || '');
          const descEl = el.querySelector('[data-value="description"]');
          if (descEl) descEl.textContent = product.description || '';
          const priceEl = el.querySelector('[data-value="price"]');
          const priceNum = typeof product.price === 'number' ? product.price : parseInt(product.price, 10) || 0;
          if (priceEl) priceEl.textContent = 'Rp ' + priceNum.toLocaleString('id-ID');
          el.setAttribute('data-product-id', product.id || '');
          return el.outerHTML;
        };

        // Render base product card
        template.outerHTML = buildProductHTML(baseProduct);

        // Render addons list (optional)
        const addonsList = document.getElementById('addonsList');
        const addonTemplate = document.getElementById('addonItemTemplate');
        if (addonsList && addonTemplate) {
          window.addonsData = addons.map(a => ({
            ...a,
            selected: false,
            quantity: (typeof a.quantity === 'number' ? a.quantity : 1) || 1
          }));

          Array.from(addonsList.children).forEach(child => {
            if (child.id !== 'addonItemTemplate') child.remove();
          });

          window.addonsData.forEach((addon, idx) => {
            const el = addonTemplate.cloneNode(true);
            el.classList.remove('hidden');
            el.id = '';
            const nameEl = el.querySelector('[data-field="name"]');
            const priceEl = el.querySelector('[data-field="price"]');
            const descEl = el.querySelector('[data-field="description"]');
            const checkbox = el.querySelector('input[type="checkbox"]');
            if (nameEl) nameEl.textContent = addon.name || '';
            const priceNum = typeof addon.price === 'number' ? addon.price : (parseInt(addon.price, 10) || 0);
            if (priceEl) priceEl.textContent = `Rp ${priceNum.toLocaleString('id-ID')}`;
            if (descEl) descEl.textContent = addon.description || '';
            if (checkbox) {
              const cid = `addon-${idx}`;
              checkbox.id = cid;
              checkbox.checked = !!addon.selected;
              el.querySelector('label')?.setAttribute('for', cid);
              checkbox.addEventListener('change', () => {
                addon.selected = checkbox.checked;
                updateSummary();
              });
            }
            addonsList.appendChild(el);
          });
        }

        // Persist base product
        if (baseProduct && baseProduct.price != null) {
          window.initialProductPrice = typeof baseProduct.price === 'number'
            ? baseProduct.price
            : parseInt(baseProduct.price, 10) || 0;
        }
        window.productData = { ...baseProduct, quantity: 1 };
        updateSummary();
      } catch (e) {
        console.warn('Gagal render produk dari data-products:', e);
      }
    })();

    // Fields
    (function initFieldRendering() {
      try {
        const raw = document.body.dataset.fields || '{}';
        const parsed = JSON.parse(raw.replace(/'/g, '"'));
        const fields = parsed.fields || [];
        const formsEl = document.getElementById('forms');
        const tpl = formsEl.querySelector('[data-role="field"]');
        formsEl.innerHTML = '';
        fields.forEach(f => {
          const el = tpl.cloneNode(true);
          const label = el.querySelector('[data-value="label"]');
          const input = el.querySelector('input');
          if (label) label.textContent = f.label + (f.required ? ' *' : '');
          if (input) {
            input.type = f.type || 'text';
            input.required = !!f.required;
            input.name = f.id; input.id = f.id;
            input.placeholder = `Masukkan ${String(f.label || '').toLowerCase()}`;
          }
          formsEl.appendChild(el);
        });
      } catch (e) {
        console.warn('Gagal render fields:', e);
      }
    })();

    function updateSummary() {
      summaryItemsContainer.innerHTML = '';
      let grandTotal = Number(window.productData?.price || 0);

      // Base product line
      if (window.productData) {
        const line = summaryItemTemplate.cloneNode(true);
        line.classList.remove('hidden');
        line.querySelector('[data-summary="name"]').textContent = window.productData.name || '';
        line.querySelector('[data-summary="qty"]').textContent = 1;
        line.querySelector('[data-summary="unit_price"]').textContent = Number(window.productData.price || 0).toLocaleString('id-ID');
        line.querySelector('[data-summary="line_total"]').textContent = Number(window.productData.price || 0).toLocaleString('id-ID');
        line.querySelector('[data-summary="weight"]').textContent = PRODUCT_WEIGHT;
        summaryItemsContainer.appendChild(line);
      }

      // Addons lines
      (window.addonsData || []).forEach(a => {
        if (!a.selected) return;
        const line = summaryItemTemplate.cloneNode(true);
        line.classList.remove('hidden');
        line.querySelector('[data-summary="name"]').textContent = `${a.name} (Addon)`;
        line.querySelector('[data-summary="qty"]').textContent = 1;
        line.querySelector('[data-summary="unit_price"]').textContent = Number(a.price || 0).toLocaleString('id-ID');
        line.querySelector('[data-summary="line_total"]').textContent = Number(a.price || 0).toLocaleString('id-ID');
        line.querySelector('[data-summary="weight"]').textContent = Number(a.weight || 0);
        summaryItemsContainer.appendChild(line);
        grandTotal += Number(a.price || 0);
      });

      totalPriceElement.textContent = Number(grandTotal).toLocaleString('id-ID');

      // Update customer data with subtotal
      window.customerData.subtotal = grandTotal;
    }

    // Multi-step
    (function initMultiStep() {
      const parents = Array.from(document.querySelectorAll('#orderForm [data-role="parent"]'));
      const prevStepBtn = document.getElementById('prevStep');
      const nextStepBtn = document.getElementById('nextStep');
      const submitBtnEl = document.getElementById('submitBtn');
      const stepCircles = Array.from(document.querySelectorAll('[data-step-circle]'));
      const stepLabels = Array.from(document.querySelectorAll('[data-step-label]'));
      let stepIndex = 0;
      function refreshStepperUI() {
        stepCircles.forEach((c, idx) => {
          if (idx <= stepIndex) { c.classList.remove('border-gray-300', 'text-gray-400'); c.classList.add('border-indigo-500', 'text-indigo-600'); }
          else { c.classList.add('border-gray-300', 'text-gray-400'); c.classList.remove('border-indigo-500', 'text-indigo-600'); }
        });
        stepLabels.forEach((l, idx) => {
          if (idx === stepIndex) { l.classList.remove('text-gray-400'); l.classList.add('text-indigo-600'); }
          else { l.classList.add('text-gray-400'); l.classList.remove('text-indigo-600'); }
        });
      }
      function showStep(i) {
        stepIndex = Math.max(0, Math.min(i, parents.length - 1));
        parents.forEach((el, idx) => el.classList.toggle('hidden', idx !== stepIndex));
        prevStepBtn.disabled = stepIndex === 0;
        prevStepBtn.classList.toggle('opacity-50', stepIndex === 0);
        nextStepBtn.classList.toggle('hidden', stepIndex === parents.length - 1);
        if (submitBtnEl) submitBtnEl.classList.toggle('hidden', stepIndex !== parents.length - 1);
        refreshStepperUI();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
      prevStepBtn.addEventListener('click', () => showStep(stepIndex - 1));
      nextStepBtn.addEventListener('click', () => { updateSummary(); showStep(stepIndex + 1); });
      showStep(0);
    })();

    // Form submission logic (without shipping cost calculation)
    const formId = document.body.dataset.formId || document.body.dataset.originId || '';
    const submitEvent = document.body.dataset.submitEvent || '';

    orderForm.addEventListener('submit', async function (e) {
      e.preventDefault();

      // Validate required fields
      let fields = [];
      try {
        const rawFields = document.body.dataset.fields || '{}';
        const parsedFields = JSON.parse(rawFields.replace(/'/g, '"'));
        fields = Array.isArray(parsedFields.fields) ? parsedFields.fields : [];
      } catch (err) { }

      const formValues = {};
      const missingRequired = [];

      fields.forEach(f => {
        const el = document.getElementById(f.id) || orderForm.querySelector(`[name="${f.id}"]`);
        const val = el ? (el.value || '').trim() : '';
        formValues[f.id] = val;
        if (f.required && !val) missingRequired.push(f.label || f.id);
      });

      if (missingRequired.length) {
        alert('Mohon lengkapi field wajib: ' + missingRequired.join(', '));
        return;
      }

      // Collect customer data
      Object.assign(window.customerData, formValues);

      // Calculate totals
      const subtotal = (window.customerData && typeof window.customerData.subtotal === 'number')
        ? window.customerData.subtotal
        : (typeof window.productData.price === 'number'
          ? window.productData.price
          : (parseInt(window.productData.price, 10) || 0));

      const total = subtotal; // No shipping cost in PD template

      // Prepare products data
      const p = window.productData;
      const baseProduct = {
        id: p.id || `SKU-1`,
        code: p.id || `SKU-1`,
        name: p.name || `Produk 1`,
        price: typeof p.price === 'number' ? p.price : (parseInt(p.price, 10) || 0),
        quantity: 1,
        is_addon: !!p.is_addon
      };

      const selectedAddons = (window.addonsData || [])
        .filter(a => a.selected)
        .map(a => ({
          id: a.id || 'ADDON',
          code: a.id || 'ADDON',
          name: a.name || 'Addon',
          price: typeof a.price === 'number' ? a.price : (parseInt(a.price, 10) || 0),
          quantity: a.quantity || 1,
          is_addon: true
        }));

      // Get UTM parameters
      const urlParams = new URLSearchParams(window.location.search);
      const utmSource = urlParams.get('utm_source') || '';
      const utmMedium = urlParams.get('utm_medium') || '';
      const utmCampaign = urlParams.get('utm_campaign') || '';
      const utmContent = urlParams.get('utm_content') || '';

      const submissionData = {
        customer_data: {
          ...window.customerData,
          utm_meta: {
            utm_source: utmSource,
            utm_medium: utmMedium,
            utm_campaign: utmCampaign,
            utm_content: utmContent
          }
        },
        subtotal: subtotal,
        total: total,
        product: [baseProduct, ...selectedAddons]
      };

      // Disable submit button
      submitBtn.disabled = true;
      submitBtn.textContent = 'Memproses...';
      submitBtn.classList.add('opacity-75', 'cursor-not-allowed');

      try {
        const response = await fetch(`${domain}/form/${formId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(submissionData)
        });

        // Track conversion events
        if (typeof fbq !== 'undefined') {
          fbq('track', submitEvent, { value: total, currency: 'IDR' });
        }
        if (typeof ttq !== 'undefined') {
          ttq.track(submitEvent, { value: total, currency: 'IDR' });
        }
        if (typeof twq !== 'undefined') {
          twq('event', submitEvent, { value: total, currency: 'IDR' });
        }

        const result = await response.json();
        if (result.id) {
          // Show success message
          successMessage.classList.remove('hidden');
          setTimeout(() => {
            successContent.classList.remove('scale-95', 'opacity-0');
            successContent.classList.add('scale-100', 'opacity-100');
            let width = 0;
            const interval = setInterval(() => {
              width += 10;
              progressBar.style.width = width + '%';
              if (width >= 100) {
                clearInterval(interval);
                // Redirect to invoice
                window.location.href = `${domain}/invoice/${result.id}`;
              }
            }, 100);
          }, 100);
        } else {
          throw new Error('Failed to submit order');
        }
      } catch (error) {
        console.error('Error submitting order:', error);
        alert('Terjadi kesalahan saat mengirim pesanan. Silakan coba lagi.');

        // Re-enable submit button
        submitBtn.disabled = false;
        submitBtn.textContent = 'Selesaikan Pesanan';
        submitBtn.classList.remove('opacity-75', 'cursor-not-allowed');
      }
    });
  </script>
</section>